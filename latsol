
<!doctype html>
<html lang="id" class="no-theme-toggle">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="theme-color" content="#3b82f6" id="themeColor" />
    <meta name="robots" content="noindex" />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=AW-16989729463"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "AW-16989729463");
    </script>
    <title>bisadanedu</title>
    <link rel="icon" href="../../img/favicon.ico" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../../src/output.css?v=10.2" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap");
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: "Inter", sans-serif;
        color: #1e293b;
        background-color: #f1f5f9;
        padding-top: env(safe-area-inset-top);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      button,
      .option-button,
      .question-number,
      [onclick] {
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
        transition: all 0.2s ease-in-out;
      }
      button:focus-visible,
      input:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 10px;
      }
      .custom-scrollbar:hover::-webkit-scrollbar-thumb {
        background-color: #94a3b8;
      }
      .question-nav-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .question-nav-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .question-number {
        border: 2px solid #e2e8f0;
        background-color: #f8fafc;
        color: #475569;
        transition: transform 0.25s ease, box-shadow 0.25s ease,
          border-color 0.25s ease, background-color 0.25s ease,
          color 0.25s ease;
      }
      .question-number.answered {
        background-color: #60a5fa;
        border-color: #3b82f6;
        color: #ffffff;
        font-weight: 600;
      }
      .question-number:disabled {
        cursor: not-allowed;
        opacity: 0.6;
        transform: none !important;
      }
      .question-number.ragu {
        background-color: #fefce8;
        border-color: #fde047;
        color: #a16207;
        font-weight: 700;
      }
      .question-number.answered-correct {
        background: linear-gradient(135deg, #4ade80, #22c55e);
        border-color: #16a34a;
        color: #ffffff;
        font-weight: 700;
        box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
        animation: latihan-result-pop 0.65s ease-out;
      }
      .question-number.answered-incorrect {
        background: linear-gradient(135deg, #f87171, #ef4444);
        border-color: #b91c1c;
        color: #ffffff;
        font-weight: 700;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        animation: latihan-result-shake 0.65s cubic-bezier(0.36, 0.07, 0.19, 0.97);
      }
      .question-number.active {
        transform: scale(1.2) translateY(-4px);
        box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.4);
      }
      .question-number.active:not(.answered-correct):not(.answered-incorrect) {
        background: linear-gradient(135deg, #60a5fa, #3b82f6);
        border-color: #2563eb;
        color: #ffffff;
      }
      .question-number,
      .option-button,
      .latihan-feedback-card {
        will-change: transform, box-shadow, filter;
      }
      .latihan-result-pop {
        animation: latihan-result-pop 0.65s ease-out;
      }
      .latihan-result-shake {
        animation: latihan-result-shake 0.65s cubic-bezier(0.36, 0.07, 0.19, 0.97);
      }
      .latihan-result-pulse {
        animation: latihan-result-pulse 0.9s ease-out;
      }
      .latihan-result-danger-frame {
        animation: latihan-result-danger-frame 0.9s ease-out;
      }
      .latihan-result-soft-success,
      .latihan-result-soft-warning,
      .latihan-result-soft-danger {
        transition: box-shadow 0.35s ease-out, filter 0.35s ease-out;
      }
      .latihan-result-soft-success {
        box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.18);
        filter: brightness(1.05);
      }
      .latihan-result-soft-warning {
        box-shadow: 0 0 0 6px rgba(251, 191, 36, 0.22);
        filter: saturate(1.05);
      }
      .latihan-result-soft-danger {
        box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.22);
        filter: saturate(1.05);
      }
      .latihan-anim-overlay {
        position: fixed;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: 9999;
      }
      .latihan-anim-overlay__particle {
        position: absolute;
        top: -12vh;
        left: 50%;
        width: var(--size, 12px);
        height: calc(var(--size, 12px) * 1.6);
        border-radius: 4px;
        background: #60a5fa;
        opacity: 0;
        transform: translate3d(0, -20vh, 0) rotate(var(--start-rotation, 0deg))
          scale(var(--scale, 1));
        animation: latihan-confetti-fall var(--duration, 1.2s)
          cubic-bezier(0.12, 0.67, 0.4, 0.97) var(--delay, 0s) forwards;
      }
      .latihan-anim-overlay__particle::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: inherit;
        filter: brightness(1.08);
      }
      .latihan-celebrate-overlay {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 9998;
        overflow: hidden;
        animation: latihan-celebrate-overlay-fade 1.1s ease-out forwards;
        will-change: opacity;
      }
      .latihan-celebrate-overlay__paper {
        position: absolute;
        top: -12vh;
        left: 50%;
        width: var(--paper-width, 12px);
        height: var(--paper-height, 18px);
        border-radius: var(--paper-radius, 6px);
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.85),
          var(--paper-color, #f97316)
        );
        opacity: 0;
        mix-blend-mode: screen;
        transform: translate3d(
            calc(-50% + var(--paper-start-x, 0px)),
            -12vh,
            0
          )
          rotate(var(--paper-rotate-start, 0deg));
        transform-origin: center;
        animation: latihan-celebrate-paper-fall var(--paper-duration, 1.6s)
          cubic-bezier(0.25, 0.1, 0.25, 1) var(--paper-delay, 0s) forwards;
        will-change: transform, opacity;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.15);
      }
      .latihan-danger-overlay {
        position: fixed;
        inset: -4px;
        z-index: 9998;
        pointer-events: none;
        border-radius: 0;
        background: rgba(248, 113, 113, 0.12);
        box-shadow: inset 0 0 0 2px rgba(248, 113, 113, 0.9),
          inset 0 0 40px 12px rgba(127, 29, 29, 0.55),
          0 0 18px 6px rgba(127, 29, 29, 0.25);
        animation: latihan-danger-overlay 0.95s ease-out forwards;
      }
      .latihan-danger-overlay::after {
        content: "";
        position: absolute;
        inset: -12px;
        border-radius: inherit;
        background: radial-gradient(
            circle at top left,
            rgba(239, 68, 68, 0.35),
            transparent 55%
          ),
          radial-gradient(
            circle at top right,
            rgba(239, 68, 68, 0.3),
            transparent 60%
          ),
          radial-gradient(
            circle at bottom left,
            rgba(248, 113, 113, 0.28),
            transparent 60%
          ),
          radial-gradient(
            circle at bottom right,
            rgba(248, 113, 113, 0.25),
            transparent 60%
          );
        opacity: 0.85;
        mix-blend-mode: screen;
        filter: blur(14px);
      }
      @keyframes latihan-result-pop {
        0% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.25);
          filter: brightness(1);
        }
        45% {
          box-shadow: 0 0 0 16px rgba(59, 130, 246, 0);
          filter: brightness(1.07);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
          filter: brightness(1);
        }
      }
      @keyframes latihan-result-shake {
        0% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.28);
          filter: saturate(1);
        }
        45% {
          box-shadow: 0 0 0 18px rgba(239, 68, 68, 0);
          filter: saturate(1.12);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
          filter: saturate(1);
        }
      }
      @keyframes latihan-result-pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.45);
        }
        60% {
          box-shadow: 0 0 0 22px rgba(59, 130, 246, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
      }
      @keyframes latihan-result-danger-frame {
        0% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.25),
            0 0 0 0 rgba(127, 29, 29, 0.35);
          filter: saturate(1);
        }
        35% {
          box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.4),
            0 0 26px 10px rgba(127, 29, 29, 0.28);
          filter: saturate(1.12);
        }
        65% {
          box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.28),
            0 0 36px 14px rgba(127, 29, 29, 0.16);
          filter: saturate(1.05);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0),
            0 0 0 0 rgba(127, 29, 29, 0);
          filter: saturate(1);
        }
      }
      @keyframes latihan-danger-overlay {
        0% {
          opacity: 0;
          transform: scale(1);
        }
        15% {
          opacity: 0.95;
          transform: scale(1.01);
        }
        45% {
          opacity: 0.75;
        }
        70% {
          opacity: 0.35;
        }
        100% {
          opacity: 0;
          transform: scale(1.02);
        }
      }
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(-8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in {
        animation: fade-in 0.3s ease-out;
      }
      @keyframes latihan-celebrate-overlay-fade {
        0% {
          opacity: 0;
        }
        15% {
          opacity: 0.85;
        }
        60% {
          opacity: 0.55;
        }
        100% {
          opacity: 0;
        }
      }
      @keyframes latihan-celebrate-paper-fall {
        0% {
          opacity: 0;
          transform: translate3d(
              calc(-50% + var(--paper-start-x, 0px)),
              -12vh,
              0
            )
            rotate(var(--paper-rotate-start, 0deg));
        }
        12% {
          opacity: 1;
        }
        78% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translate3d(
              calc(-50% + var(--paper-end-x, 0px)),
              96vh,
              0
            )
            rotate(var(--paper-rotate-end, 360deg));
        }
      }
      @media (prefers-reduced-motion: reduce) {
        html {
          scroll-behavior: auto;
        }
        .latihan-result-pop,
        .latihan-result-shake,
        .latihan-result-pulse,
        .latihan-result-danger-frame,
        .latihan-anim-overlay,
        .latihan-anim-overlay__particle,
        .latihan-danger-overlay,
        .latihan-celebrate-overlay,
        .latihan-celebrate-overlay__paper {
          animation: none !important;
        }
        .latihan-result-soft-success,
        .latihan-result-soft-warning,
        .latihan-result-soft-danger {
          transition: none !important;
        }
        .question-number,
        .option-button {
          transition: none !important;
        }
      }
      @keyframes latihan-confetti-fall {
        0% {
          opacity: 0;
          transform: translate3d(0, -20vh, 0) rotate(var(--start-rotation, 0deg))
            scale(var(--scale, 1));
        }
        15% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translate3d(var(--drift, 0px), 110vh, 0)
            rotate(var(--end-rotation, 360deg)) scale(var(--scale, 1));
        }
      }
      .option-button {
        border: 2px solid #e2e8f0;
        transition: transform 0.25s ease, box-shadow 0.25s ease,
          border-color 0.25s ease, background-color 0.25s ease,
          color 0.25s ease;
      }
      .option-button:hover {
        transform: translateY(-2px);
        border-color: #bfdbfe;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
      }
      .option-button.selected {
        background-color: #dbeafe !important;
        border-color: #3b82f6 !important;
      }
      .option-button.selected .option-text {
        color: #2563eb;
        font-weight: 600;
      }
      .option-button.correct {
        background-color: #dcfce7 !important;
        border-color: #22c55e !important;
      }
      .option-button.incorrect {
        background-color: #fee2e2 !important;
        border-color: #ef4444 !important;
        opacity: 0.8;
      }
      .option-button--locked {
        pointer-events: none;
        opacity: 0.65;
        cursor: not-allowed;
      }
      .option-button:disabled {
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .option-checkbox {
        width: 2.25rem;
        height: 2.25rem;
        border: 2px solid #cbd5e1;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8fafc;
        transition: all 0.2s ease-in-out;
        position: relative;
        color: #2563eb;
        box-shadow: inset 0 1px 1px rgba(15, 23, 42, 0.05);
      }
      .option-checkbox::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.6);
        font-size: 1.05rem;
        font-weight: 700;
        color: currentColor;
        line-height: 1;
        opacity: 0;
        transition:
          opacity 0.2s ease,
          transform 0.2s ease;
      }
      .option-button.selected .option-checkbox,
      .option-button.correct .option-checkbox,
      .option-button.incorrect .option-checkbox {
        color: #ffffff;
      }
      .option-button.selected .option-checkbox {
        background-color: #3b82f6;
        border-color: #3b82f6;
        box-shadow: 0 4px 8px -1px rgba(59, 130, 246, 0.3);
      }
      .option-button.selected .option-checkbox::after {
        content: "✓";
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      .option-button.correct .option-checkbox {
        background-color: #22c55e;
        border-color: #22c55e;
      }
      .option-button.correct .option-checkbox::after {
        content: "✓";
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      .option-button.incorrect .option-checkbox {
        background-color: #ef4444;
        border-color: #ef4444;
      }
      .option-button.incorrect .option-checkbox::after {
        content: "✕";
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      .complex-option-locked {
        pointer-events: none !important;
        opacity: 0.65;
        cursor: not-allowed;
      }
      .short-answer-locked {
        cursor: not-allowed;
        opacity: 0.65;
      }

      .timer-display {
        font-variant-numeric: tabular-nums;
      }
      .timer-critical {
        animation: pulse-critical 1.5s infinite ease-in-out;
      }
      @keyframes pulse-critical {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 8px rgba(220, 38, 38, 0);
        }
      }
      .fade-in {
        animation: fadeIn 0.6s ease-out forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .score-update {
        animation: score-pulse 0.6s ease-out;
      }
      @keyframes score-pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.25);
        }
        100% {
          transform: scale(1);
        }
      }
      .modal-backdrop {
        background-color: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(8px);
      }
      .modal-content {
        transform: scale(0.95) translateY(20px);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .modal-content.show {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
      @media (max-width: 640px) {
        .modal-sheet {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          width: 100%;
          max-width: 100%;
          margin: 0;
          border-radius: 24px 24px 0 0;
          transform: translateY(100%);
        }
        .modal-sheet.show {
          transform: translateY(0);
        }
        #startQuizModalContent.modal-sheet {
          height: 100%;
          max-height: 100%;
          border-radius: 0;
        }
      }
      .start-note-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px 16px;
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 14px;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
      }
      .start-note-icon {
        width: 36px;
        height: 36px;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: 0 4px 12px -6px rgba(15, 23, 42, 0.4);
      }
      .start-note-icon--primary {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1d4ed8;
      }
      .start-note-icon--warning {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #b45309;
      }
      .start-note-icon--success {
        background: linear-gradient(135deg, #dcfce7, #bbf7d0);
        color: #15803d;
      }
      .btn-primary {
        background: linear-gradient(135deg, #60a5fa, #3b82f6);
        color: white;
        box-shadow: 0 4px 15px -5px rgba(59, 130, 246, 0.5);
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #60a5fa, #2563eb);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px -5px rgba(59, 130, 246, 0.6);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .mode-selector-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      @media (min-width: 640px) {
        .mode-selector-grid {
          gap: 12px;
        }
      }
      .mode-option {
        position: relative;
        display: block;
      }
      .mode-option input[type="radio"] {
        position: absolute;
        inset: 0;
        opacity: 0;
      }
      .mode-card {
        position: relative;
        padding: 14px 12px;
        border-radius: 12px;
        background: #ffffff;
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 10px 25px -18px rgba(15, 23, 42, 0.45);
        overflow: hidden;
        transition:
          transform 0.25s ease,
          box-shadow 0.25s ease,
          border-color 0.25s ease,
          background 0.25s ease;
        cursor: pointer;
        min-height: 100%;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      @media (min-width: 640px) {
        .mode-card {
          padding: 18px 16px;
          border-radius: 16px;
          gap: 12px;
        }
      }
      .mode-card::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0;
        background: radial-gradient(
          circle at top right,
          rgba(59, 130, 246, 0.16),
          transparent 60%
        );
        transition: opacity 0.3s ease;
      }
      .mode-card--latihan::after {
        background: radial-gradient(
          circle at top right,
          rgba(16, 185, 129, 0.18),
          transparent 62%
        );
      }
      .mode-card__content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        text-align: center;
      }
      @media (min-width: 640px) {
        .mode-card__content {
          gap: 10px;
        }
      }
      .mode-card__icon {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        background: rgba(59, 130, 246, 0.12);
        color: #1d4ed8;
        box-shadow: 0 10px 25px -20px rgba(30, 64, 175, 0.8);
      }
      @media (min-width: 640px) {
        .mode-card__icon {
          width: 44px;
          height: 44px;
          border-radius: 14px;
        }
      }
      .mode-card__badge {
        font-size: 9px;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.06em;
        padding: 4px 8px;
        border-radius: 9999px;
        color: #1d4ed8;
        background: rgba(59, 130, 246, 0.12);
        box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.18);
      }
      @media (min-width: 640px) {
        .mode-card__badge {
          font-size: 11px;
          letter-spacing: 0.08em;
          padding: 6px 12px;
        }
      }
      .mode-card__title {
        font-size: 12px;
        font-weight: 700;
        color: #1e293b;
        letter-spacing: -0.01em;
      }
      @media (min-width: 640px) {
        .mode-card__title {
          font-size: 14px;
        }
      }
      .mode-card__description {
        font-size: 10px;
        line-height: 1.5;
        color: #475569;
        text-align: center;
      }
      @media (min-width: 640px) {
        .mode-card__description {
          font-size: 12px;
          line-height: 1.6;
        }
      }
      .mode-card--latihan .mode-card__icon,
      .mode-card--latihan .mode-card__badge {
        background: rgba(16, 185, 129, 0.12);
        color: #047857;
        box-shadow: inset 0 0 0 1px rgba(16, 185, 129, 0.18);
      }
      .mode-option:hover .mode-card {
        transform: translateY(-4px);
        box-shadow: 0 16px 35px -20px rgba(15, 23, 42, 0.55);
      }
      .mode-option input[type="radio"]:focus-visible + .mode-card {
        outline: 3px solid rgba(59, 130, 246, 0.35);
        outline-offset: 2px;
      }
      .mode-option input[type="radio"]:checked + .mode-card {
        border-color: rgba(59, 130, 246, 0.65);
        box-shadow: 0 20px 45px -24px rgba(37, 99, 235, 0.55);
        transform: translateY(-4px);
      }
      .mode-option input[type="radio"]:checked + .mode-card::after {
        opacity: 1;
      }
      .mode-option input[type="radio"]:checked + .mode-card .mode-card__badge,
      .mode-option input[type="radio"]:checked + .mode-card .mode-card__icon {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.16),
          rgba(59, 130, 246, 0.05)
        );
        color: #1d4ed8;
      }
      .mode-option input[type="radio"]:checked + .mode-card.mode-card--latihan {
        border-color: rgba(16, 185, 129, 0.65);
        box-shadow: 0 20px 45px -24px rgba(5, 122, 85, 0.55);
      }
      .mode-option
        input[type="radio"]:checked
        + .mode-card.mode-card--latihan
        .mode-card__badge,
      .mode-option
        input[type="radio"]:checked
        + .mode-card.mode-card--latihan
        .mode-card__icon {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.18),
          rgba(16, 185, 129, 0.06)
        );
        color: #047857;
      }
      .confirm-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 260px;
        align-self: center;
        padding: 0.9rem 1.5rem;
        border-radius: 9999px;
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: 0.01em;
        border: none;
        transition:
          transform 0.25s ease,
          box-shadow 0.25s ease,
          background 0.25s ease;
        color: #ffffff;
        box-shadow: 0 12px 24px -18px rgba(15, 23, 42, 0.65);
      }
      .confirm-button:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 30px -20px rgba(15, 23, 42, 0.65);
      }
      .confirm-button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .confirm-button--primary {
        background: linear-gradient(135deg, #60a5fa, #2563eb);
      }
      .confirm-button--success {
        background: linear-gradient(135deg, #34d399, #059669);
      }
      .confirm-button--warning {
        background: linear-gradient(135deg, #fbbf24, #d97706);
      }
      .confirm-button--danger {
        background: linear-gradient(135deg, #f87171, #dc2626);
      }
      .latihan-action-stack .confirm-button {
        max-width: 100%;
        align-self: stretch;
      }
      .action-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .action-control-button {
        min-width: 3.5rem;
        min-height: 3.5rem;
      }
      .action-controls--latihan {
        flex-wrap: nowrap;
        align-items: center;
        gap: 20px;
      }
      .action-controls--latihan > * {
        flex-shrink: 0;
      }
      .latihan-action-stack {
        display: flex;
        flex-direction: column;
        gap: 14px;
        width: 100%;
        margin: 0 auto;
        flex-basis: 100%;
      }
      .ragu-toggle-label {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-height: 3.5rem;
        padding: 0 1.9rem;
        border: 2px solid #e2e8f0;
        border-radius: 9999px;
        font-weight: 600;
        color: #334155;
        background-color: #ffffff;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 6px 18px -14px rgba(15, 23, 42, 0.4);
      }
      .ragu-toggle-label:hover {
        background-color: #f1f5f9;
        border-color: #d0d8e4;
      }
      .ragu-toggle-label:focus-visible {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
      }
      .ragu-toggle-label--active {
        background-color: #fefce8;
        border-color: #fde047;
        color: #a16207;
        box-shadow: 0 16px 30px -20px rgba(217, 119, 6, 0.6);
        transform: translateY(-1px);
      }
      .ragu-toggle-label--focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
      }
      @media (min-width: 768px) {
        .action-controls--latihan {
          display: flex;
          justify-content: space-between;
        }
        .latihan-action-stack {
          order: 2;
          flex-basis: auto;
          max-width: 360px;
        }
      }
      @media (max-width: 767px) {
        .action-controls--latihan {
          display: grid;
          grid-template-columns: auto minmax(0, 1fr) auto;
          gap: 12px;
          align-items: center;
          justify-items: stretch;
        }
        .action-controls--latihan .latihan-action-stack {
          grid-column: 2 / 3;
          order: 2;
          align-self: stretch;
        }
        .action-controls--latihan .latihan-action-stack .confirm-button {
          width: 100%;
        }
        .action-controls--latihan .action-btn-prev {
          grid-column: 1 / 2;
          justify-self: start;
          order: 1;
        }
        .action-controls--latihan .action-btn-next {
          grid-column: 3 / 4;
          justify-self: end;
          order: 3;
        }
      }
      .latihan-feedback-card {
        background: #ffffff;
        border-radius: 22px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 22px;
        box-shadow: 0 18px 45px -36px rgba(15, 23, 42, 0.65);
        display: flex;
        flex-direction: column;
        gap: 18px;
        position: relative;
        overflow: hidden;
      }
      .latihan-feedback-card--success {
        border-color: rgba(16, 185, 129, 0.35);
        background: linear-gradient(180deg, rgba(236, 253, 245, 0.85), #ffffff);
      }
      .latihan-feedback-card--warning {
        border-color: rgba(251, 191, 36, 0.32);
        background: linear-gradient(180deg, rgba(254, 243, 199, 0.85), #ffffff);
      }
      .latihan-feedback-card--danger {
        border-color: rgba(248, 113, 113, 0.32);
        background: linear-gradient(180deg, rgba(254, 226, 226, 0.85), #ffffff);
      }
      .latihan-feedback-card__header {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .latihan-feedback-card__icon {
        width: 46px;
        height: 46px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        background: rgba(59, 130, 246, 0.12);
        color: #1d4ed8;
      }
      .latihan-feedback-card__icon--success {
        background: rgba(16, 185, 129, 0.15);
        color: #047857;
      }
      .latihan-feedback-card__icon--warning {
        background: rgba(251, 191, 36, 0.15);
        color: #b45309;
      }
      .latihan-feedback-card__icon--danger {
        background: rgba(248, 113, 113, 0.18);
        color: #b91c1c;
      }
      .latihan-feedback-card__title {
        font-size: 0.95rem;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.08em;
        color: #1e293b;
      }
      .latihan-feedback-card__title--success {
        color: #047857;
      }
      .latihan-feedback-card__title--warning {
        color: #b45309;
      }
      .latihan-feedback-card__title--danger {
        color: #b91c1c;
      }
      .latihan-feedback-card__note {
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        margin-top: 2px;
      }
      .latihan-feedback-card__body {
        display: grid;
        gap: 14px;
      }
      .latihan-feedback-card__section {
        border-radius: 16px;
        padding: 16px;
        background: rgba(241, 245, 249, 0.75);
        border: 1px solid rgba(203, 213, 225, 0.7);
      }
      .latihan-feedback-card__section-title {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #475569;
        margin-bottom: 6px;
      }
      .latihan-feedback-card__section-text {
        font-size: 14px;
        color: #1e293b;
        line-height: 1.7;
      }
      .latihan-feedback-card__section--solution {
        background: rgba(16, 185, 129, 0.08);
        border-color: rgba(16, 185, 129, 0.35);
      }
      .latihan-feedback-card__section--explain {
        background: rgba(59, 130, 246, 0.07);
        border-color: rgba(59, 130, 246, 0.28);
      }
      html.dark .mode-card {
        background: rgba(15, 23, 42, 0.88);
        border-color: rgba(148, 163, 184, 0.22);
        box-shadow: 0 20px 60px -40px rgba(15, 23, 42, 0.9);
      }
      html.dark .mode-card::after {
        background: radial-gradient(
          circle at top right,
          rgba(96, 165, 250, 0.15),
          transparent 65%
        );
      }
      html.dark .mode-card--latihan::after {
        background: radial-gradient(
          circle at top right,
          rgba(52, 211, 153, 0.18),
          transparent 65%
        );
      }
      html.dark .mode-card__title {
        color: #e2e8f0;
      }
      html.dark .mode-card__description {
        color: rgba(203, 213, 225, 0.8);
      }
      html.dark .mode-card__badge,
      html.dark .mode-card__icon {
        background: rgba(59, 130, 246, 0.18);
        color: #93c5fd;
        box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.25);
      }
      html.dark .mode-card--latihan .mode-card__badge,
      html.dark .mode-card--latihan .mode-card__icon {
        background: rgba(16, 185, 129, 0.18);
        color: #6ee7b7;
        box-shadow: inset 0 0 0 1px rgba(16, 185, 129, 0.25);
      }
      html.dark .mode-option input[type="radio"]:checked + .mode-card {
        border-color: rgba(59, 130, 246, 0.8);
        background:
          linear-gradient(
            135deg,
            rgba(37, 99, 235, 0.2),
            rgba(15, 23, 42, 0.92)
          ),
          rgba(15, 23, 42, 0.95);
        box-shadow: 0 30px 70px -40px rgba(37, 99, 235, 0.55);
      }
      html.dark
        .mode-option
        input[type="radio"]:checked
        + .mode-card.mode-card--latihan {
        border-color: rgba(16, 185, 129, 0.85);
        background:
          linear-gradient(
            135deg,
            rgba(16, 185, 129, 0.16),
            rgba(15, 23, 42, 0.92)
          ),
          rgba(15, 23, 42, 0.95);
        box-shadow: 0 30px 70px -40px rgba(5, 122, 85, 0.55);
      }
      html.dark .confirm-button {
        box-shadow: 0 20px 45px -30px rgba(15, 23, 42, 0.8);
      }
      html.dark .confirm-button:not(:disabled):hover {
        box-shadow: 0 30px 60px -35px rgba(15, 23, 42, 0.9);
      }
      html.dark .action-controls--latihan {
        gap: 20px;
      }
      html.dark .ragu-toggle-label {
        background-color: #1f2937;
        border-color: #334155;
        color: #cbd5e1;
        box-shadow: 0 6px 18px -14px rgba(2, 6, 23, 0.75);
      }
      html.dark .ragu-toggle-label:hover {
        background-color: #273248;
        border-color: #475569;
      }
      html.dark .ragu-toggle-label--active {
        background-color: #422006;
        border-color: #f59e0b;
        color: #fcd34d;
        box-shadow: 0 16px 30px -24px rgba(217, 119, 6, 0.55);
      }
      html.dark .ragu-toggle-label--focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.35);
      }
      html.dark .latihan-feedback-card {
        background: rgba(15, 23, 42, 0.9);
        border-color: rgba(148, 163, 184, 0.2);
        box-shadow: 0 25px 55px -40px rgba(0, 0, 0, 0.65);
      }
      html.dark .latihan-feedback-card--success {
        background:
          linear-gradient(
            180deg,
            rgba(7, 59, 50, 0.55),
            rgba(15, 23, 42, 0.92)
          ),
          rgba(15, 23, 42, 0.92);
        border-color: rgba(16, 185, 129, 0.3);
      }
      html.dark .latihan-feedback-card--warning {
        background:
          linear-gradient(
            180deg,
            rgba(69, 40, 2, 0.55),
            rgba(15, 23, 42, 0.92)
          ),
          rgba(15, 23, 42, 0.92);
        border-color: rgba(251, 191, 36, 0.28);
      }
      html.dark .latihan-feedback-card--danger {
        background:
          linear-gradient(
            180deg,
            rgba(67, 16, 16, 0.6),
            rgba(15, 23, 42, 0.92)
          ),
          rgba(15, 23, 42, 0.92);
        border-color: rgba(248, 113, 113, 0.28);
      }
      html.dark .latihan-feedback-card__title {
        color: #e2e8f0;
      }
      html.dark .latihan-feedback-card__title--success {
        color: #6ee7b7;
      }
      html.dark .latihan-feedback-card__title--warning {
        color: #fcd34d;
      }
      html.dark .latihan-feedback-card__title--danger {
        color: #fca5a5;
      }
      html.dark .latihan-feedback-card__note {
        color: rgba(203, 213, 225, 0.7);
      }
      html.dark .latihan-feedback-card__section {
        background: rgba(30, 41, 59, 0.75);
        border-color: rgba(148, 163, 184, 0.25);
      }
      html.dark .latihan-feedback-card__section--solution {
        background: rgba(4, 120, 87, 0.18);
        border-color: rgba(45, 212, 191, 0.35);
      }
      html.dark .latihan-feedback-card__section--explain {
        background: rgba(37, 99, 235, 0.18);
        border-color: rgba(96, 165, 250, 0.32);
      }
      html.dark .latihan-feedback-card__section-title {
        color: rgba(226, 232, 240, 0.75);
      }
      html.dark .latihan-feedback-card__section-text {
        color: rgba(226, 232, 240, 0.92);
      }
      #teks-soal svg,
      #teks-soal-mobile svg,
      .pembahasan-math-wrapper svg {
        max-width: 100%;
        height: auto;
        max-height: 40vh;
        display: block;
        margin: 1rem auto;
        object-fit: contain;
      }
      .pembahasan-math-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 4px;
        border-radius: 4px;
      }
      .result-bg {
        background-color: #3b82f6;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1600 800'%3e%3cg stroke='%23ffffff' stroke-width='0.5' stroke-opacity='0.1'%3e%3ccircle fill='%233b82f6' cx='0' cy='0' r='1800'/%3e%3ccircle fill='%23387bef' cx='0' cy='0' r='1700'/%3e%3ccircle fill='%233573e8' cx='0' cy='0' r='1600'/%3e%3ccircle fill='%23326ce1' cx='0' cy='0' r='1500'/%3e%3ccircle fill='%232f65da' cx='0' cy='0' r='1400'/%3e%3ccircle fill='%232c5ed3' cx='0' cy='0' r='1300'/%3e%3ccircle fill='%232957cc' cx='0' cy='0' r='1200'/%3e%3ccircle fill='%232650c5' cx='0' cy='0' r='1100'/%3e%3ccircle fill='%232349be' cx='0' cy='0' r='1000'/%3e%3ccircle fill='%232042b7' cx='0' cy='0' r='900'/%3e%3ccircle fill='%231d3bb0' cx='0' cy='0' r='800'/%3e%3ccircle fill='%231a34a9' cx='0' cy='0' r='700'/%3e%3ccircle fill='%23172da2' cx='0' cy='0' r='600'/%3e%3ccircle fill='%2314269b' cx='0' cy='0' r='500'/%3e%3ccircle fill='%23111f94' cx='0' cy='0' r='400'/%3e%3ccircle fill='%230e188d' cx='0' cy='0' r='300'/%3e%3ccircle fill='%230b1186' cx='0' cy='0' r='200'/%3e%3ccircle fill='%23080a7f' cx='0' cy='0' r='100'/%3e%3c/g%3e%3c/svg%3e");
        background-size: cover;
        background-position: center;
      }
      .score-display {
        animation: score-pop-in 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }
      @keyframes score-pop-in {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .detail-item {
        animation: detail-fade-in 0.5s ease-out forwards;
        opacity: 0;
        transform: translateX(20px);
      }
      @keyframes detail-fade-in {
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      .table-wrapper {
        overflow-x: auto;
        width: 100%;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        margin: 1rem 0;
        background: #ffffff;
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
      }
      .styled-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: clamp(0.8rem, 2.5vw, 0.95rem);
      }
      .styled-table th,
      .styled-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
        white-space: nowrap;
      }
      .styled-table thead th {
        background: linear-gradient(180deg, #f8fafc, #eef2ff);
        font-weight: 600;
        color: #334155;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: clamp(0.75rem, 2vw, 0.85rem);
      }
      .styled-table thead th:first-child {
        border-top-left-radius: 0.75rem;
      }
      .styled-table thead th:last-child {
        border-top-right-radius: 0.75rem;
      }
      .styled-table tbody tr:last-child td {
        border-bottom: none;
      }
      .styled-table tbody tr:nth-child(even) {
        background-color: #f8fafc;
      }
      .styled-table tbody tr:hover {
        background-color: #eef2ff;
      }
      .styled-table .statement-cell {
        white-space: normal;
      }
      .pembahasan-card summary::-webkit-details-marker {
        display: none;
      }
      .navigator-btn.navigator-active {
        border-width: 2px;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        transform: scale(1.1);
      }
      .complex-summary-table-wrapper {
        overflow-x: auto;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        background-color: #ffffff;
        box-shadow: inset 0 1px 1px rgba(148, 163, 184, 0.12);
        margin: 0 !important;
        padding: 0.75rem 0.85rem;
      }
      .complex-summary-table {
        width: 100%;
        min-width: 520px;
        border-collapse: separate;
        border-spacing: 0;
      }
      .complex-summary-table thead th {
        padding: 0.85rem 1rem;
        text-align: center;
        font-size: 0.75rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: #0f172a;
        background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
        box-shadow: inset 0 -1px 0 rgba(148, 163, 184, 0.35);
      }
      .complex-summary-table thead th:first-child {
        border-top-left-radius: 0.75rem;
        text-align: left;
      }
      .complex-summary-table thead th:last-child {
        border-top-right-radius: 0.75rem;
      }
      .complex-summary-table tbody tr {
        transition: background 0.25s ease;
      }
      .complex-summary-table tbody tr:nth-child(even) {
        background-color: #f8fafc;
      }
      .complex-summary-table tbody tr:nth-child(odd) {
        background-color: #ffffff;
      }
      .complex-summary-table tbody tr:hover {
        background-color: #eef2ff;
      }
      .complex-summary-table tbody tr:hover .user-cell-inner {
        border-color: rgba(59, 130, 246, 0.35);
        box-shadow: inset 0 1px 2px rgba(59, 130, 246, 0.18);
      }
      .complex-summary-table tbody td {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
        font-size: 0.925rem;
        color: #1e293b;
      }
      .complex-summary-table tbody td + td {
        border-left: 1px solid rgba(226, 232, 240, 0.7);
      }
      .complex-summary-table tbody tr:last-child td {
        border-bottom: none;
      }
      .complex-summary-table tbody tr:last-child td:first-child {
        border-bottom-left-radius: 0.75rem;
      }
      .complex-summary-table tbody tr:last-child td:last-child {
        border-bottom-right-radius: 0.75rem;
      }
      .complex-summary-table tbody td:first-child {
        padding-left: 1.35rem;
      }
      .complex-summary-table tbody td:last-child {
        padding-right: 1.35rem;
      }
      .complex-summary-table .statement-cell {
        font-weight: 600;
        width: 48%;
        text-align: left;
        line-height: 1.6;
      }
      .complex-summary-table td.user-cell {
        text-align: center;
        width: 26%;
        padding: 0;
        vertical-align: middle;
      }
      .complex-summary-table td.answer-cell {
        text-align: center;
        width: 26%;
        padding: 0.75rem 1rem;
        vertical-align: middle;
      }
      .complex-summary-table td.answer-cell strong {
        color: #166534;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.95rem;
        letter-spacing: 0.01em;
        white-space: nowrap;
        line-height: 1.3;
      }
      .user-response-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        min-height: 44px;
        flex: 1 0 auto;
      }
      .user-cell {
        padding: 0;
      }
      .user-cell-inner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        border-radius: 0.75rem;
        border: 1px solid transparent;
        padding: 0.75rem;
        background-color: rgba(248, 250, 252, 0.85);
        box-shadow: inset 0 1px 1px rgba(148, 163, 184, 0.18);
        transition:
          background-color 0.2s ease,
          border-color 0.2s ease,
          box-shadow 0.2s ease;
        width: 100%;
        min-height: 64px;
      }
      .user-response {
        font-weight: 600;
        color: inherit;
        display: inline-block;
        font-size: 0.95rem;
        letter-spacing: 0.01em;
        white-space: nowrap;
        line-height: 1.3;
      }
      .user-response-correct {
        color: #166534;
      }
      .user-response-wrong {
        color: #b91c1c;
        text-decoration: line-through;
        text-decoration-thickness: 2px;
        text-decoration-color: rgba(220, 38, 38, 0.7);
      }
      .user-response-empty em {
        color: #94a3b8;
      }
      .user-response em {
        color: #94a3b8;
        font-style: italic;
      }
      .result-summary-box {
        background-color: #eff6ff;
        border: 1px solid #bfdbfe;
      }
      .result-summary-title {
        color: #1d4ed8;
      }
      .result-explanation-box {
        background-color: #f8fafc;
        border: 1px solid #cbd5e1;
        color: #1f2937;
      }
      .complex-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.2rem 0.6rem;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.02em;
        background-color: #e2e8f0;
        color: #475569;
        margin-top: 0.25rem;
      }
      .complex-status-badge.badge-neutral {
        background-color: #e2e8f0;
        color: #475569;
      }
      .user-cell-inner.user-cell-correct {
        background-color: rgba(220, 252, 231, 0.88);
        border-color: #86efac;
        color: #166534;
        box-shadow: inset 0 1px 2px rgba(34, 197, 94, 0.18);
      }
      .user-cell-inner.user-cell-wrong {
        background-color: rgba(254, 226, 226, 0.88);
        border-color: #fecaca;
        color: #b91c1c;
        box-shadow: inset 0 1px 2px rgba(239, 68, 68, 0.18);
      }
      .user-cell-inner.user-cell-neutral {
        background-color: #f1f5f9;
        border-color: #cbd5e1;
        color: #475569;
        box-shadow: inset 0 1px 1px rgba(148, 163, 184, 0.18);
      }
      @media (max-width: 640px) {
        .complex-summary-table-wrapper {
          border-radius: 0.75rem;
        }
        .complex-summary-table {
          min-width: 420px;
        }
        .complex-summary-table thead th,
        .complex-summary-table tbody td {
          padding: 0.6rem 0.75rem;
          font-size: 0.85rem;
        }
        .complex-summary-table tbody td:first-child {
          padding-left: 1rem;
        }
        .complex-summary-table tbody td:last-child {
          padding-right: 1rem;
        }
        .complex-summary-table td.answer-cell {
          padding: 0.55rem 0.6rem;
        }
        .user-cell-inner {
          min-height: 48px;
          padding: 0.55rem 0.65rem;
          gap: 0.25rem;
        }
        .user-response-wrapper {
          min-height: 28px;
        }
        .user-response {
          font-size: 0.82rem;
        }
        .complex-status-badge {
          font-size: 0.62rem;
          margin-top: 0.12rem;
          padding: 0.16rem 0.45rem;
        }
      }
      mjx-container,
      .pembahasan-math-wrapper {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      mjx-container::-webkit-scrollbar,
      .pembahasan-math-wrapper::-webkit-scrollbar {
        display: none;
        width: 0;
        height: 0;
        background: transparent;
      }
      @media (max-width: 640px) {
        * {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
        *::-webkit-scrollbar {
          display: none;
          width: 0;
          height: 0;
          background: transparent;
        }
      }
      html.dark body {
        background-color: #020617;
        color: #cbd5e1;
      }
      html.dark .bg-slate-100 {
        background-color: #020617;
      }
      html.dark .bg-slate-50 {
        background-color: #0f172a;
      }
      html.dark .text-slate-800,
      html.dark .text-slate-900,
      html.dark .text-green-900 {
        color: #f1f5f9;
      }
      html.dark .text-slate-500,
      html.dark .text-slate-600,
      html.dark .text-slate-700 {
        color: #94a3b8;
      }
      html.dark .border-slate-200 {
        border-color: #334155;
      }
      html.dark .border-slate-100 {
        border-color: #1e293b;
      }
      html.dark .bg-white {
        background-color: #1e293b;
      }
      html.dark .bg-white\/80 {
        background-color: rgba(30, 41, 59, 0.8);
      }
      html.dark .bg-white\/90 {
        background-color: rgba(30, 41, 59, 0.9);
      }
      html.dark .shadow-lg {
        box-shadow:
          0 10px 15px -3px rgba(0, 0, 0, 0.3),
          0 4px 6px -4px rgba(0, 0, 0, 0.4);
      }
      html.dark .shadow-sm {
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      }
      html.dark .shadow-2xl {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }
      html.dark .question-number {
        border-color: #475569;
        background-color: #334155;
        color: #cbd5e1;
      }
      html.dark .question-number.answered {
        background-color: #0d9488;
        border-color: #2dd4bf;
        color: #ffffff;
      }
      html.dark .question-number.ragu {
        background-color: #422006;
        border-color: #f59e0b;
        color: #fcd34d;
      }
      html.dark .option-button {
        background-color: #1e293b;
        border-color: #475569;
      }
      html.dark .option-button:hover {
        border-color: #60a5fa;
      }
      html.dark .option-button.selected {
        background-color: #1e40af !important;
        border-color: #60a5fa !important;
      }
      html.dark .option-button.selected .option-text {
        color: #f8fafc;
      }
      html.dark .option-button.correct {
        background-color: #166534 !important;
        border-color: #4ade80 !important;
      }
      html.dark .option-button.incorrect {
        background-color: #991b1b !important;
        border-color: #f87171 !important;
      }
      html.dark .option-checkbox {
        background-color: #0f172a;
        border-color: #475569;
        box-shadow: inset 0 1px 1px rgba(15, 23, 42, 0.35);
        color: #60a5fa;
      }
      html.dark .option-button.selected .option-checkbox {
        background: #60a5fa;
        border-color: #60a5fa;
        color: #0f172a;
      }
      html.dark .option-button.correct .option-checkbox {
        background-color: #4ade80;
        border-color: #4ade80;
        color: #14532d;
      }
      html.dark .option-button.incorrect .option-checkbox {
        background-color: #f87171;
        border-color: #f87171;
        color: #7f1d1d;
      }
      html.dark .bg-slate-200 {
        background-color: #334155;
      }
      html.dark .text-slate-700 {
        color: #cbd5e1;
      }
      html.dark .bg-slate-100 {
        background-color: #0f172a;
      }
      html.dark .hover\:bg-slate-200:hover {
        background-color: #475569;
      }
      html.dark .bg-red-100 {
        background-color: #450a0a;
      }
      html.dark .text-red-600,
      html.dark .text-red-800 {
        color: #fca5a5;
      }
      html.dark .ring-red-50 {
        --tw-ring-color: rgba(239, 68, 68, 0.2);
      }
      html.dark .bg-yellow-100 {
        background-color: #422006;
      }
      html.dark .text-yellow-600 {
        color: #fcd34d;
      }
      html.dark .ring-yellow-50 {
        --tw-ring-color: rgba(234, 179, 8, 0.2);
      }
      html.dark .bg-red-600 {
        background-color: #dc2626;
      }
      html.dark .hover\:bg-red-700:hover {
        background-color: #b91c1c;
      }
      html.dark .focus\:ring-red-300:focus {
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4);
      }
      html.dark .bg-green-100 {
        background-color: #14532d;
      }
      html.dark .text-green-600,
      html.dark .text-green-800 {
        color: #86efac;
      }
      html.dark .text-green-700 {
        color: #4ade80;
      }
      html.dark .start-note-item {
        background-color: #1f2937;
        border-color: #334155;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.3);
        color: #cbd5e1;
      }
      html.dark .start-note-icon {
        box-shadow: 0 4px 12px -6px rgba(15, 23, 42, 0.6);
      }
      html.dark .start-note-icon--primary {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.28),
          rgba(96, 165, 250, 0.35)
        );
        color: #bfdbfe;
      }
      html.dark .start-note-icon--warning {
        background: linear-gradient(
          135deg,
          rgba(253, 230, 138, 0.28),
          rgba(250, 204, 21, 0.35)
        );
        color: #fde68a;
      }
      html.dark .start-note-icon--success {
        background: linear-gradient(
          135deg,
          rgba(134, 239, 172, 0.3),
          rgba(34, 197, 94, 0.3)
        );
        color: #bbf7d0;
      }
      html.dark .bg-blue-100 {
        background-color: #1e3a8a;
      }
      html.dark .text-blue-600 {
        color: #93c5fd;
      }
      html.dark .result-bg {
        background-color: #1e293b;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1600 800'%3e%3cg stroke='%23ffffff' stroke-width='0.5' stroke-opacity='0.1'%3e%3ccircle fill='%230f172a' cx='0' cy='0' r='1800'/%3e%3ccircle fill='%23111a31' cx='0' cy='0' r='1700'/%3e%3ccircle fill='%23131e38' cx='0' cy='0' r='1600'/%3e%3ccircle fill='%2315223f' cx='0' cy='0' r='1500'/%3e%3ccircle fill='%23172546' cx='0' cy='0' r='1400'/%3e%3ccircle fill='%2319294e' cx='0' cy='0' r='1300'/%3e%3ccircle fill='%231b2d55' cx='0' cy='0' r='1200'/%3e%3ccircle fill='%231d315c' cx='0' cy='0' r='1100'/%3e%3ccircle fill='%231f3564' cx='0' cy='0' r='1000'/%3e%3ccircle fill='%2321396b' cx='0' cy='0' r='900'/%3e%3ccircle fill='%23233c72' cx='0' cy='0' r='800'/%3e%3ccircle fill='%2325407a' cx='0' cy='0' r='700'/%3e%3ccircle fill='%23274481' cx='0' cy='0' r='600'/%3e%3ccircle fill='%23294888' cx='0' cy='0' r='500'/%3e%3ccircle fill='%232c4c90' cx='0' cy='0' r='400'/%3e%3ccircle fill='%232e5097' cx='0' cy='0' r='300'/%3e%3ccircle fill='%2330549e' cx='0' cy='0' r='200'/%3e%3ccircle fill='%233258a6' cx='0' cy='0' r='100'/%3e%3c/g%3e%3c/svg%3e");
      }
      html.dark .text-blue-200 {
        color: #94a3b8;
      }
      html.dark #animated-score-desktop {
        color: #f1f5f9;
      }
      html.dark .bg-green-50 {
        background-color: rgba(34, 197, 94, 0.1);
      }
      html.dark .text-green-800 {
        color: #bbf7d0;
      }
      html.dark .bg-red-50 {
        background-color: rgba(239, 68, 68, 0.1);
      }
      html.dark .text-red-800 {
        color: #fca5a5;
      }
      html.dark .bg-yellow-50 {
        background-color: rgba(234, 179, 8, 0.1);
      }
      html.dark .text-yellow-800 {
        color: #fde047;
      }
      html.dark .table-wrapper {
        background: #1e293b;
        border-color: #475569;
      }
      html.dark .styled-table thead th {
        background: linear-gradient(180deg, #1e293b, #334155);
        color: #f8fafc;
        border-bottom: 2px solid #475569;
      }
      html.dark .styled-table tbody tr {
        background-color: #1e293b !important;
      }
      html.dark .styled-table tbody tr:nth-child(even) {
        background-color: #0f172a !important;
      }
      html.dark .styled-table tbody tr:hover {
        background-color: #334155 !important;
        transition: background-color 0.2s ease;
      }
      html.dark .styled-table td,
      html.dark .styled-table th {
        border-bottom-color: #475569;
        color: #e2e8f0 !important;
      }
      html.dark .complex-summary-table-wrapper {
        border-color: #475569;
        background-color: #1e293b;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      }
      html.dark .complex-summary-table thead th {
        background: linear-gradient(180deg, #334155, #1e293b);
        border-color: #475569;
        color: #f8fafc;
        box-shadow: inset 0 -2px 0 rgba(71, 85, 105, 0.5);
        font-weight: 600;
      }
      html.dark .complex-summary-table tbody tr:nth-child(odd) {
        background-color: #1e293b !important;
      }
      html.dark .complex-summary-table tbody tr:nth-child(even) {
        background-color: #0f172a !important;
      }
      html.dark .complex-summary-table tbody tr:hover {
        background-color: rgba(59, 130, 246, 0.15) !important;
        transition: background-color 0.2s ease;
      }
      html.dark .complex-summary-table tbody tr:hover .user-cell-inner {
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3), inset 0 1px 2px rgba(59, 130, 246, 0.2);
      }
      html.dark .complex-summary-table tbody td {
        border-color: #475569;
        color: #f1f5f9 !important;
        background-color: transparent;
      }
      html.dark .complex-summary-table tbody td + td {
        border-left: 1px solid #475569;
      }
      html.dark .complex-summary-table td.answer-cell strong {
        color: #86efac;
        font-weight: 600;
      }
      html.dark .user-response-correct {
        color: #86efac;
        font-weight: 500;
      }
      html.dark .user-response-wrong {
        color: #fca5a5;
        text-decoration-color: rgba(239, 68, 68, 0.7);
      }
      html.dark .result-summary-box {
        background-color: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.4);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
      }
      html.dark .result-summary-title {
        color: #93c5fd;
        font-weight: 600;
      }
      html.dark .result-explanation-box {
        background-color: #1e293b;
        border: 1px solid #475569;
        color: #f1f5f9;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      html.dark .complex-status-badge.badge-neutral {
        background-color: rgba(148, 163, 184, 0.32);
        color: #e2e8f0;
      }
      html.dark .user-cell-inner {
        background-color: #334155;
        border: 1px solid #475569;
        color: #f1f5f9;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      html.dark .user-cell-inner.user-cell-correct {
        background-color: rgba(34, 197, 94, 0.2);
        border: 2px solid #22c55e;
        color: #86efac;
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3), inset 0 1px 2px rgba(34, 197, 94, 0.15);
      }
      html.dark .user-cell-inner.user-cell-wrong {
        background-color: rgba(239, 68, 68, 0.2);
        border: 2px solid #ef4444;
        color: #fca5a5;
        box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.3), inset 0 1px 2px rgba(239, 68, 68, 0.15);
      }
      html.dark .user-cell-inner.user-cell-neutral {
        background-color: rgba(100, 116, 139, 0.3);
        border: 1px solid #64748b;
        color: #cbd5e1;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      html.dark .complex-status-badge {
        background-color: rgba(148, 163, 184, 0.25);
        color: #cbd5e1;
        border: 1px solid #475569;
        font-weight: 500;
      }
      html.dark .bg-blue-50 {
        background-color: rgba(59, 130, 246, 0.15);
      }
      html.dark .text-blue-800 {
        color: #60a5fa;
      }
      html.dark .border-green-500 {
        border-color: #22c55e;
      }
      html.dark .border-red-500 {
        border-color: #ef4444;
      }
      html.dark .hover\:bg-slate-100:hover {
        background-color: #1e293b;
        transition: background-color 0.2s ease;
      }
      /* Scrollbar styling for dark mode */
      html.dark .table-wrapper::-webkit-scrollbar,
      html.dark .complex-summary-table-wrapper::-webkit-scrollbar {
        height: 8px;
        width: 8px;
      }
      html.dark .table-wrapper::-webkit-scrollbar-track,
      html.dark .complex-summary-table-wrapper::-webkit-scrollbar-track {
        background: #0f172a;
        border-radius: 4px;
      }
      html.dark .table-wrapper::-webkit-scrollbar-thumb,
      html.dark .complex-summary-table-wrapper::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 4px;
      }
      html.dark .table-wrapper::-webkit-scrollbar-thumb:hover,
      html.dark .complex-summary-table-wrapper::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }
      /* SVG text color in dark mode */
      /* Only apply white color to SVG text if SVG doesn't have background */
      html.dark svg:not([style*="background"]):not([fill]):not(:has(rect[fill])) text,
      html.dark svg:not([style*="background"]):not([fill]):not(:has(rect[fill])) tspan {
        fill: #ffffff !important;
      }
      html.dark svg:not([style*="background"]):not([fill]):not(:has(rect[fill])) {
        color: #ffffff;
      }

      /* SVG with background keeps original text color */
      html.dark svg[style*="background"] text,
      html.dark svg[style*="background"] tspan,
      html.dark svg[fill] text,
      html.dark svg[fill] tspan,
      html.dark svg:has(rect[fill]) text,
      html.dark svg:has(rect[fill]) tspan {
        fill: inherit;
      }
      /* Logo should have no forced background/border */
      img[alt="Logo"] {
        background-color: transparent;
        border: 0;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
      }
    </style>
    <script>
      (function () {
        try {
          var t = localStorage.getItem("theme");
          if (
            t
              ? t === "dark"
              : window.matchMedia &&
                window.matchMedia("(prefers-color-scheme: dark)").matches
          ) {
            document.documentElement.classList.add("dark");
          }
        } catch (e) {}
      })();
    </script>
    <script src="../../assets/theme.js"></script>
    <style id="fix-dark-green-contrast">
      /* Active navigation number with ragu in dark mode: amber glow */
      html.dark .question-number.ragu.active {
        box-shadow: 0 10px 20px -5px rgba(245, 158, 11, 0.35);
      }
      /* Ensure 'jawaban benar' (green text) stays readable on dark backgrounds */
      html.dark .text-green-600,
    html.dark .text-green-800,
    body.dark .text-green-600,
    body.dark .text-green-800,
    html[data-theme="dark"] .text-green-600,
    html[data-theme="dark"] .text-green-800,
    body[data-theme="dark"] .text-green-600,
    body[data-theme="dark"] .text-green-800,
    /* Tailwind dark: variant classes (escaped colon) */
    html.dark .dark\:text-green-600,
    html.dark .dark\:text-green-800,
    body.dark .dark\:text-green-600,
    body.dark .dark\:text-green-800,
    html[data-theme="dark"] .dark\:text-green-600,
    html[data-theme="dark"] .dark\:text-green-800,
    body[data-theme="dark"] .dark\:text-green-600,
    body[data-theme="dark"] .dark\:text-green-800 {
        color: #ffffff !important; /* bright text for dark mode */
      }
      /* If the text sits on green badges/pills, force white for contrast */
      html.dark .bg-green-600 .text-green-600,
      html.dark .bg-green-700 .text-green-800,
      body.dark .bg-green-600 .text-green-600,
      body.dark .bg-green-700 .text-green-800,
      html[data-theme="dark"] .bg-green-600 .text-green-600,
      html[data-theme="dark"] .bg-green-700 .text-green-800 {
        color: #ffffff !important;
      }
    </style>
    <script src="../../assets/logo-theme.js" defer></script>
    <style id="dark-mode-results-enhancements">
      html.dark .result-bg {
        background-color: #020617; /* slate-950 */
        background-image:
          radial-gradient(
            circle at top,
            rgba(30, 41, 59, 0.5) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at bottom,
            rgba(59, 130, 246, 0.2) 0%,
            transparent 60%
          );
      }

      html.dark #animated-score,
      html.dark #animated-score-desktop {
        color: #ffffff;
        text-shadow:
          0 0 15px rgba(255, 255, 255, 0.3),
          0 0 30px rgba(59, 130, 246, 0.4);
      }

      html.dark .result-bg .text-blue-200 {
        color: #93c5fd; /* blue-300 */
      }

      html.dark .result-bg .font-bold.text-white {
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      /* Summary Items on Mobile */
      html.dark .detail-item .bg-green-100 {
        background-color: rgba(16, 185, 129, 0.15);
      }
      html.dark .detail-item .text-green-600 {
        color: #6ee7b7;
      }
      html.dark .detail-item .bg-red-100 {
        background-color: rgba(239, 68, 68, 0.15);
      }
      html.dark .detail-item .text-red-600 {
        color: #f87171;
      }
      html.dark .detail-item .bg-yellow-100 {
        background-color: rgba(245, 158, 11, 0.15);
      }
      html.dark .detail-item .text-yellow-600 {
        color: #fbbf24;
      }
      html.dark .detail-item .bg-slate-200 {
        background-color: rgba(100, 116, 139, 0.2);
      }
      html.dark .detail-item .text-slate-600 {
        color: #94a3b8;
      }

      /* Summary Items on Desktop */
      html.dark .detail-item.bg-green-50 {
        background-color: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
      }
      html.dark .detail-item.bg-red-50 {
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }
      html.dark .detail-item.bg-slate-100 {
        background-color: rgba(100, 116, 139, 0.15);
        border: 1px solid rgba(100, 116, 139, 0.25);
      }

      /* Pembahasan Card Mobile */
      html.dark .pembahasan-card {
        background-color: #020617; /* slate-950 */
        border-color: #334155; /* slate-700 */
      }
      html.dark .pembahasan-card summary:hover {
        background-color: #1e293b; /* slate-800 */
      }
      html.dark .pembahasan-card .border-t {
        border-color: #1e293b; /* slate-800 */
      }
      html.dark .pembahasan-card.border-green-500 {
        border-left-color: #10b981;
      } /* emerald-500 */
      html.dark .pembahasan-card.border-red-500 {
        border-left-color: #ef4444;
      } /* red-500 */

      /* Pembahasan Card Desktop */
      html.dark .pembahasan-card-desktop {
        background-color: #0f172a; /* slate-900 */
      }
      html.dark .pembahasan-card-desktop.border-green-400 {
        background-color: rgba(16, 185, 129, 0.05);
        border-color: rgba(16, 185, 129, 0.3);
      }
      html.dark .pembahasan-card-desktop.border-red-400 {
        background-color: rgba(239, 68, 68, 0.05);
        border-color: rgba(239, 68, 68, 0.3);
      }

      /* Explanation Box */
      html.dark .result-explanation-box {
        background-color: #1e293b; /* slate-800 */
        border: 1px solid #334155; /* slate-700 */
        color: #cbd5e1; /* slate-300 */
      }

      /* Button on mobile to see explanation */
      html.dark button.bg-slate-100 {
        background-color: #334155; /* slate-700 */
        color: #cbd5e1; /* slate-300 */
      }
      html.dark button.bg-slate-100:hover {
        background-color: #475569; /* slate-600 */
      }
    </style>
  </head>
  <body class="bg-slate-100 overflow-hidden">
    <div
      id="loadingScreen"
      class="fixed inset-0 bg-white flex flex-col justify-center items-center z-[100] transition-opacity duration-500"
    >
      <div class="w-16 h-16 relative">
        <div
          class="absolute inset-0 rounded-full border-t-4 border-blue-500 animate-spin"
        ></div>
      </div>
      <p class="mt-4 text-slate-500 font-medium text-sm tracking-wider">
        MEMUAT...
      </p>
    </div>
    <div
      id="securityErrorModal"
      class="fixed inset-0 z-[99] hidden items-center justify-center p-4 modal-backdrop"
    >
      <div
        class="bg-white p-8 max-w-md w-full mx-4 shadow-2xl modal-content rounded-xl"
      >
        <div class="text-center">
          <div
            class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-5 ring-4 ring-red-50"
          >
            <svg
              class="h-8 w-8 text-red-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
          </div>
          <h3 class="text-2xl font-bold text-slate-800 mb-3">Akses Ditolak</h3>
          <p
            id="securityErrorMessage"
            class="text-slate-600 mb-8 text-[12px] sm:text-base"
          ></p>
          <button
            onclick="goToHome()"
            class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold transform hover:scale-105 focus:ring-4 focus:ring-red-300"
          >
            Kembali ke Menu Utama
          </button>
        </div>
      </div>
    </div>
    <div
      id="questionSetErrorModal"
      class="fixed inset-0 z-[99] hidden items-center justify-center p-4 modal-backdrop"
    >
      <div
        class="bg-white p-8 max-w-md w-full mx-4 shadow-2xl modal-content modal-sheet rounded-xl"
      >
        <div class="text-center">
          <div
            class="mx-auto w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mb-5 ring-4 ring-yellow-50"
          >
            <svg
              class="h-8 w-8 text-yellow-600"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
          <h3 class="text-2xl font-bold text-slate-800 mb-3">
            Gagal Memuat Soal
          </h3>
          <p class="text-slate-600 mb-8">
            Set soal ini sedang dalam perbaikan, cobalah beberapa saat lagi.
            Anda akan diarahkan kembali secara otomatis.
          </p>
        </div>
      </div>
    </div>
    <div
      id="startQuizModal"
      class="fixed inset-0 z-[99] hidden items-center justify-center p-4 modal-backdrop"
    >
      <div
        id="startQuizModalContent"
        class="bg-white p-4 sm:p-8 max-w-2xl w-full mx-4 shadow-2xl modal-content modal-sheet rounded-2xl flex flex-col max-h-[90vh]"
      >
        <div class="flex justify-between items-center mb-3 flex-shrink-0">
          <div>
            <p class="text-xs sm:text-sm text-slate-500">Anda akan memulai</p>
            <h3 id="quiz-title" class="text-lg sm:text-2xl font-bold text-slate-800">
              Kuis
            </h3>
          </div>
          <button
            onclick="goToHome()"
            class="flex items-center gap-1 text-xs sm:text-sm font-semibold text-slate-500 hover:text-red-500 transition"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="w-4 h-4 sm:w-5 sm:h-5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            <span class="hidden xs:inline">Menu Utama</span>
            <span class="xs:hidden">Menu</span>
          </button>
        </div>
        <div class="flex-grow overflow-y-auto custom-scrollbar pr-1">
          <div class="flex sm:grid sm:grid-cols-2 gap-2 sm:gap-3 mb-4">
            <div
              class="flex items-center gap-2 sm:gap-3 bg-slate-50 rounded-lg sm:rounded-xl p-2.5 sm:p-3 border border-slate-200 flex-1"
            >
              <div
                class="w-9 h-9 sm:w-12 sm:h-12 flex-shrink-0 bg-blue-100 text-blue-600 rounded-lg sm:rounded-xl flex items-center justify-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 sm:h-6 sm:w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                  />
                </svg>
              </div>
              <div class="min-w-0">
                <p class="text-[10px] sm:text-sm text-slate-500">Jumlah Soal</p>
                <p
                  id="quiz-question-count"
                  class="font-bold text-slate-800 text-sm sm:text-lg"
                >
                  Memuat...
                </p>
              </div>
            </div>
            <div
              class="flex items-center gap-2 sm:gap-3 bg-slate-50 rounded-lg sm:rounded-xl p-2.5 sm:p-3 border border-slate-200 flex-1"
            >
              <div
                class="w-9 h-9 sm:w-12 sm:h-12 flex-shrink-0 bg-blue-100 text-blue-600 rounded-lg sm:rounded-xl flex items-center justify-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 sm:h-6 sm:w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <div class="min-w-0">
                <p class="text-[10px] sm:text-sm text-slate-500">Durasi</p>
                <p id="quiz-duration" class="font-bold text-slate-800 text-sm sm:text-lg">
                  Memuat...
                </p>
              </div>
            </div>
          </div>
          <div class="mt-4 sm:mt-6">
            <h3 class="font-bold text-slate-800 mb-2 sm:mb-3 text-base sm:text-lg">
              Pilih Mode Pengerjaan
            </h3>
            <div class="mode-selector-grid">
              <label class="mode-option">
                <input type="radio" name="quiz-mode" value="ujian" />
                <div class="mode-card mode-card--ujian">
                  <div class="mode-card__content">
                    <div class="mode-card__icon">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 sm:h-6 sm:w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 6v6l2.5 2.5M12 22a10 10 0 110-20 10 10 0 010 20z"
                        />
                      </svg>
                    </div>
                    <div class="mode-card__title">Mode Ujian</div>
                  </div>
                  <p class="mode-card__description">
                    Menggunakan timer resmi. Pembahasan lengkap tersedia setelah
                    menyelesaikan seluruh soal.
                  </p>
                </div>
              </label>
              <label class="mode-option">
                <input type="radio" name="quiz-mode" value="latihan" />
                <div class="mode-card mode-card--latihan">
                  <div class="mode-card__content">
                    <div class="mode-card__icon">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 sm:h-6 sm:w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                    </div>
                    <div class="mode-card__title">Mode Latihan</div>
                  </div>
                  <p class="mode-card__description">
                    Tanpa timer. Jawaban, kunci, dan pembahasan tampil segera
                    setelah Anda konfirmasi tiap soal.
                  </p>
                </div>
              </label>
            </div>
          </div>
        </div>
        <div class="mt-4 pt-4 sm:mt-6 sm:pt-6 border-t border-slate-200 flex-shrink-0">
          <button
            id="startQuizBtn"
            class="w-full btn-primary font-bold text-base sm:text-lg px-5 py-3 sm:px-6 sm:py-4 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-opacity"
            disabled
          >
            Pilih Mode Terlebih Dahulu
          </button>
        </div>
      </div>
    </div>
    <div id="quiz-wrapper" class="hidden">
      <div id="quiz-container" class="hidden h-screen lg:flex lg:flex-row">
        <aside
          class="w-72 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 h-screen"
        >
          <div
            class="p-4 border-b border-slate-200 flex items-center justify-center"
          >
            <img
              src="../../img/bisadanedu_logo_terang.png?v=2"
              data-logo-light="../../img/bisadanedu_logo_terang.png?v=2"
              data-logo-dark="../../img/bisadanedu_logo_gelap.png?v=2"
              alt="Logo"
              class="h-9 object-contain"
              onerror="this.onerror=null; this.src='https://placehold.co/130x40/3b82f6/white?text=Logo';"
            />
          </div>
          <div class="p-4 border-b border-slate-200">
            <div class="flex items-center gap-2">
              <div class="flex-1 flex items-center gap-2">
                <div
                  id="live-score-container"
                  class="score-container flex items-center justify-center bg-blue-500 text-white font-bold rounded-full w-10 h-10 text-lg"
                >
                  <span id="live-score">0</span>
                </div>
                <div
                  id="timer"
                  class="flex items-center justify-center bg-slate-100 text-slate-700 font-semibold rounded-lg px-3 h-10 transition-all duration-300"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 mr-2"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <div class="timer-display">
                    <span id="minutes">00</span>:<span id="seconds">00</span>
                  </div>
                </div>
              </div>
              <div class="w-auto">
                <button
                  id="btn-akhiri"
                  onclick="showConfirmModal()"
                  class="w-full bg-red-600 hover:bg-red-700 text-white flex items-center justify-center gap-2 px-4 h-10 rounded-lg transform hover:scale-105 focus:ring-4 focus:ring-red-300 shadow-sm"
                >
                  <svg
                    class="w-5 h-5"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div class="flex-1 p-4 overflow-y-auto custom-scrollbar">
            <h3 class="font-bold text-slate-800 mb-4 text-center">
              Navigasi Soal
            </h3>
            <div id="nomor-soal-container" class="grid grid-cols-5 gap-3"></div>
          </div>
        </aside>
        <div class="flex-1 flex flex-col overflow-hidden">
          <main class="flex-1 min-h-0 flex flex-col p-4 lg:p-6">
            <div class="flex gap-6 h-full">
              <section
                class="lg:w-1/2 bg-white rounded-2xl shadow-lg border-slate-200/50 flex flex-col"
              >
                <div
                  class="p-6 border-b border-slate-200 flex-shrink-0 flex justify-between items-center"
                >
                  <h2
                    id="nomor-soal-judul"
                    class="text-xl font-bold text-slate-800"
                  >
                    Soal 1
                  </h2>
                  <div class="flex items-center gap-2">
                    <button
                      id="zoom-out-btn"
                      title="Perkecil Teks"
                      class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-md hover:bg-slate-200 transition"
                    >
                      <svg
                        class="w-5 h-5 text-slate-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M20 12H4"
                        ></path>
                      </svg>
                    </button>
                    <button
                      id="zoom-in-btn"
                      title="Perbesar Teks"
                      class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-md hover:bg-slate-200 transition"
                    >
                      <svg
                        class="w-5 h-5 text-slate-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 4v16m8-8H4"
                        ></path>
                      </svg>
                    </button>
                  </div>
                </div>
                <div
                  id="teks-soal"
                  class="p-6 text-base text-slate-700 leading-relaxed overflow-y-auto custom-scrollbar flex-1"
                ></div>
              </section>
              <section
                class="lg:w-1/2 bg-white rounded-2xl shadow-lg border-slate-200/50 flex flex-col"
              >
                <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                  <div id="pilihan-container" class="space-y-3"></div>
                  <div id="feedback-container" class="mt-6"></div>
                </div>
                <div class="p-6 border-t border-slate-200 flex-shrink-0">
                  <div id="action-container"></div>
                </div>
              </section>
            </div>
          </main>
        </div>
      </div>
      <div id="quiz-container-mobile" class="block lg:hidden pb-28">
        <header
          class="sticky top-0 bg-white/80 backdrop-blur-lg shadow-sm z-40"
        >
          <div
            class="container mx-auto px-4 py-3 flex items-center justify-between"
          >
            <img
              src="../../img/bisadanedu_logo_terang.png?v=2"
              data-logo-light="../../img/bisadanedu_logo_terang.png?v=2"
              data-logo-dark="../../img/bisadanedu_logo_gelap.png?v=2"
              alt="Logo"
              class="h-9 object-contain"
              onerror="this.onerror=null; this.src='https://placehold.co/130x40/3b82f6/white?text=Logo';"
            />
            <div class="flex items-center gap-3">
              <div
                id="live-score-container-mobile"
                class="score-container flex items-center justify-center bg-blue-500 text-white font-bold rounded-full w-10 h-10 text-lg"
              >
                <span id="live-score-mobile">0</span>
              </div>
              <div
                id="timer-mobile"
                class="flex items-center justify-center bg-slate-100 text-slate-700 font-semibold rounded-lg px-3 h-10 transition-all duration-300"
              ></div>
              <button
                id="btn-akhiri-mobile"
                onclick="showConfirmModal()"
                class="bg-red-600 hover:bg-red-700 text-white flex items-center justify-center w-10 h-10 rounded-lg"
              >
                <svg
                  class="w-5 h-5"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                  />
                </svg>
              </button>
            </div>
          </div>
          <div class="bg-white border-y border-slate-200">
            <div class="container mx-auto">
              <div class="overflow-x-auto question-nav-scrollbar">
                <div
                  id="nomor-soal-container-mobile"
                  class="flex gap-3 min-w-max py-3 px-4"
                ></div>
              </div>
            </div>
          </div>
        </header>
        <main class="container mx-auto p-4">
          <section class="bg-white rounded-2xl shadow-lg border-slate-200/50">
            <div
              class="p-4 sm:p-6 border-b border-slate-200 flex justify-between items-center"
            >
              <h2
                id="nomor-soal-judul-mobile"
                class="text-lg sm:text-xl font-bold text-slate-800"
              >
                Soal 1
              </h2>
              <div class="flex items-center gap-2">
                <button
                  id="zoom-out-btn-mobile"
                  title="Perkecil Teks"
                  class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-md"
                >
                  <svg
                    class="w-5 h-5 text-slate-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M20 12H4"
                    ></path>
                  </svg>
                </button>
                <button
                  id="zoom-in-btn-mobile"
                  title="Perbesar Teks"
                  class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-md"
                >
                  <svg
                    class="w-5 h-5 text-slate-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
            <div
              id="teks-soal-mobile"
              class="p-4 sm:p-6 text-base text-slate-700 leading-relaxed"
            ></div>
            <div class="p-4 sm:p-6 border-t border-slate-100">
              <div id="pilihan-container-mobile" class="space-y-3"></div>
              <div id="feedback-container-mobile" class="mt-6"></div>
            </div>
          </section>
        </main>
        <div
          class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm border-t border-slate-200 p-4 z-50 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]"
          style="padding-bottom: calc(1rem + env(safe-area-inset-bottom))"
        >
          <div id="action-container-mobile" class="container mx-auto"></div>
        </div>
      </div>
    </div>
    <div
      id="confirmModal"
      class="fixed inset-0 z-[99] hidden items-center justify-center p-4 sm:p-0 modal-backdrop"
    >
      <div
        id="modalContent"
        class="bg-white p-6 sm:p-8 sm:max-w-md w-full sm:mx-4 shadow-2xl modal-content modal-sheet rounded-xl"
      >
        <div class="text-center mb-6">
          <div
            class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-5 ring-4 ring-red-50"
          >
            <svg
              class="h-8 w-8 text-red-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
          </div>
          <h3
            id="confirmModalTitle"
            class="text-2xl font-bold text-slate-800 mb-2"
          >
            Akhiri Kuis?
          </h3>
          <p id="confirmModalText" class="text-slate-600">
            Semua jawaban akan disimpan. Anda yakin ingin menyelesaikan sesi
            ini?
          </p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
          <button
            onclick="closeConfirmModal()"
            class="flex-1 px-4 py-3 text-slate-800 bg-slate-100 hover:bg-slate-200 rounded-xl font-semibold transition-all duration-300"
          >
            Batal
          </button>
          <button
            onclick="handleConfirm()"
            class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold shadow-sm hover:shadow-md"
          >
            Ya, Akhiri
          </button>
        </div>
      </div>
    </div>
    <div id="modal-hasil" class="fixed inset-0 bg-slate-100 z-50 hidden"></div>
    <script>
      const quizConfig = {
        tka_mtk: {
          categoryId: "matematika",
          menuFile: "../tka",
        },
        tka_bahasaindo: {
          categoryId: "bahasa_indonesia",
          menuFile: "../tka",
        },
        tka_bahasainggris: {
          categoryId: "bahasa_inggris",
          menuFile: "../tka",
        },
        tka_fisika: {
          categoryId: "fisika",
          menuFile: "../tka",
        },
        tka_biologi: {
          categoryId: "biologi",
          menuFile: "../tka",
        },
        tka_kimia: {
          categoryId: "kimia",
          menuFile: "../tka",
        },
        tka_eko: {
          categoryId: "ekonomi",
          menuFile: "../tka",
        },
        tka_sosiologi: {
          categoryId: "sosiologi",
          menuFile: "../tka",
        },
        tka_geografi: {
          categoryId: "geografi",
          menuFile: "../tka",
        },
        tka_sejarah: {
          categoryId: "sejarah",
          menuFile: "../tka",
        },
        tka_pp: {
          categoryId: "pendidikan_pancasila",
          menuFile: "../tka",
        },
        tka_uji_coba: {
          categoryId: "uji_coba",
          menuFile: "../tka",
        },
        skd_wawasan_kebangsaan: {
          categoryId: "twk",
          menuFile: "../skd",
        },
        skd_intelegensia_umum: {
          categoryId: "tiu",
          menuFile: "../skd",
        },
        skd_tkp: {
          categoryId: "tkp",
          menuFile: "../skd",
        },
        bumn_tkd: {
          categoryId: "tkd",
          menuFile: "../bumn",
        },
        bumn_akhlak: {
          categoryId: "corevalue",
          menuFile: "../bumn",
        },
        bumn_wawasan_kebangsaan: {
          categoryId: "twk",
          menuFile: "../bumn",
        },
        snbt_pu: {
          categoryId: "pu",
          menuFile: "../snbt",
        },
        snbt_pema_u: {
          categoryId: "ppu",
          menuFile: "../snbt",
        },
        snbt_kmbm: {
          categoryId: "pbm",
          menuFile: "../snbt",
        },
        snbt_pk: {
          categoryId: "pk",
          menuFile: "../snbt",
        },
        snbt_pm: {
          categoryId: "pm",
          menuFile: "../snbt",
        },
        snbt_lite_indo: {
          categoryId: "li",
          menuFile: "../snbt",
        },
        snbt_lite_inggris: {
          categoryId: "ling",
          menuFile: "../snbt",
        },
      };
      function generateUUID() {
        if (typeof crypto !== "undefined" && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            var r = (Math.random() * 16) | 0,
              v = c == "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }
      class SecurityManager {
        constructor() {
          this.sessionId = this.getOrCreateSessionId();
        }
        getOrCreateSessionId() {
          const SESSION_KEY = "user_session_id";
          try {
            let sessionId = localStorage.getItem(SESSION_KEY);
            if (!sessionId) {
              sessionId = generateUUID();
              localStorage.setItem(SESSION_KEY, sessionId);
            }
            return sessionId;
          } catch (e) {
            console.warn(
              "Local storage is not available. Using a temporary session ID."
            );
            return generateUUID();
          }
        }
        validateToken(token) {
          let tokenDataStr;
          try {
            tokenDataStr = localStorage.getItem(`quiz_token_${token}`);
          } catch (e) {
            return {
              valid: false,
              reason:
                "Penyimpanan lokal tidak dapat diakses. Silakan periksa pengaturan browser Anda.",
            };
          }
          if (!tokenDataStr) {
            return {
              valid: false,
              reason: "Token tidak ditemukan. Sesi mungkin telah berakhir.",
            };
          }
          try {
            const tokenData = JSON.parse(tokenDataStr);
            if (Date.now() > tokenData.expiresAt) {
              localStorage.removeItem(`quiz_token_${token}`);
              return {
                valid: false,
                reason: "Sesi kuis telah berakhir (expired).",
              };
            }
            if (tokenData.used) {
              return {
                valid: false,
                reason:
                  "Token kuis ini sudah pernah digunakan untuk menyelesaikan kuis.",
              };
            }
            if (tokenData.sessionId !== this.sessionId) {
              return {
                valid: false,
                reason:
                  "Token tidak valid untuk perangkat ini. Silakan mulai kuis dari menu utama.",
              };
            }
            return {
              valid: true,
              data: tokenData,
            };
          } catch (error) {
            try {
              localStorage.removeItem(`quiz_token_${token}`);
            } catch (e) {}
            return {
              valid: false,
              reason: "Token kuis tidak valid atau rusak.",
            };
          }
        }
        markTokenAsCompleted(token) {
          try {
            const tokenDataStr = localStorage.getItem(`quiz_token_${token}`);
            if (!tokenDataStr) return;
            const tokenData = JSON.parse(tokenDataStr);
            tokenData.used = true;
            tokenData.usedAt = Date.now();
            localStorage.setItem(
              `quiz_token_${token}`,
              JSON.stringify(tokenData)
            );
          } catch (error) {
            console.error("Failed to mark token as completed:", error);
          }
        }
      }
      const securityManager = new SecurityManager();
      const MODE_UJIAN = "ujian";
      const MODE_LATIHAN = "latihan";
      const getSessionKey = (token) => `quiz_session_v2_${quizMode}_${token}`;
      function saveQuizState(token) {
        if (!token) return;
        const state = {
          soalSekarang,
          nomorSoalAktif,
          jawabanPengguna,
          jawabanKompleks,
          jawabanSingkat,
          submittedStatus,
          raguRaguStatus,
          correctStatus,
          liveScore,
          startTime,
          duration,
          zoomLevel,
          dataSoal,
          quizMode,
        };
        try {
          localStorage.setItem(getSessionKey(token), JSON.stringify(state));
        } catch (e) {
          console.warn("Could not save quiz state to local storage.");
        }
      }
      function loadQuizState(token) {
        if (!token) return null;
        try {
          const savedState = localStorage.getItem(getSessionKey(token));
          if (savedState) {
            return JSON.parse(savedState);
          }
        } catch (e) {
          clearQuizState(token);
          return null;
        }
        return null;
      }
      function clearQuizState(token) {
        if (!token) return;
        try {
          localStorage.removeItem(getSessionKey(token));
        } catch (e) {
          console.warn("Could not clear quiz state from local storage.");
        }
      }
      function showSecurityError(message) {
        document.body.classList.remove("overflow-hidden");
        const modal = document.getElementById("securityErrorModal");
        const content = modal.querySelector(".modal-content");
        document.getElementById("securityErrorMessage").textContent = message;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        setTimeout(() => content.classList.add("show"), 50);
      }
      function showQuestionSetError() {
        console.log("showQuestionSetError invoked", {
          hasDataSoal: !!dataSoal,
          soalLen: Array.isArray(soalSekarang) ? soalSekarang.length : null,
          token,
        });
        document.body.classList.remove("overflow-hidden");
        const modal = document.getElementById("questionSetErrorModal");
        const content = modal.querySelector(".modal-content");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        setTimeout(() => content.classList.add("show"), 50);
        setTimeout(() => {
          goToHome();
        }, 5000);
      }
      function goToHome() {
        if (tokenData && tokenData.data) {
          const testType = tokenData.data.testType;
          const config = quizConfig[testType];
          if (config && config.menuFile) {
            window.location.href =
              config.menuFile +
              (config.categoryId ? `#${config.categoryId}` : "");
          } else {
            window.location.href = "../../#latihan-soal";
          }
        } else {
          window.location.href = "../../#latihan-soal";
        }
      }
      function showConfirmModal() {
        const modal = document.getElementById("confirmModal");
        const content = document.getElementById("modalContent");
        const unansweredCount = soalSekarang.filter(
          (_, i) => !isQuestionAnswered(i)
        ).length;
        if (quizMode === MODE_UJIAN && unansweredCount > 0) {
          document.getElementById("confirmModalTitle").textContent =
            `Ada ${unansweredCount} Soal Belum Dijawab`;
          document.getElementById("confirmModalText").textContent =
            "Anda masih memiliki soal yang belum terjawab. Yakin ingin mengakhiri ujian?";
        } else {
          document.getElementById("confirmModalTitle").textContent =
            "Akhiri Sesi?";
          document.getElementById("confirmModalText").textContent =
            "Semua progres akan disimpan. Anda yakin ingin menyelesaikan sesi ini?";
        }
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        setTimeout(() => content.classList.add("show"), 50);
      }
      function closeConfirmModal() {
        const modal = document.getElementById("confirmModal");
        const content = document.getElementById("modalContent");
        content.classList.remove("show");
        setTimeout(() => modal.classList.add("hidden"), 400);
      }
      function handleConfirm() {
        closeConfirmModal();
        setTimeout(selesaiQuiz, 400);
      }
      let dataSoal = null,
        soalSekarang = [],
        nomorSoalAktif = 0,
        jawabanPengguna = [],
        jawabanKompleks = [],
        jawabanSingkat = [],
        submittedStatus = [],
        raguRaguStatus = [],
        correctStatus = [],
        liveScore = 0,
        intervalTimer,
        startTime,
        duration = 0,
        tokenData = null,
        zoomLevel = 100,
        questionNumberButtons = [],
        questionNumberButtonsMobile = [],
        prevActiveButtonIndex = 0,
        token = null,
        quizMode = MODE_UJIAN,
        modeSelectionInitialized = false;
      const MIN_ZOOM = 70,
        MAX_ZOOM = 150,
        ZOOM_STEP = 10;
      const LATIHAN_EFFECT_DURATION = 900;
      const LATIHAN_STATIC_HIGHLIGHTS = {
        success: "latihan-result-soft-success",
        partial: "latihan-result-soft-warning",
        danger: "latihan-result-soft-danger",
      };
      const reduceMotionQuery =
        typeof window !== "undefined" && window.matchMedia
          ? window.matchMedia("(prefers-reduced-motion: reduce)")
          : null;
      let prefersReducedMotion = reduceMotionQuery
        ? reduceMotionQuery.matches
        : false;
      if (reduceMotionQuery) {
        const updateMotionPreference = (event) => {
          prefersReducedMotion = !!event.matches;
        };
        if (typeof reduceMotionQuery.addEventListener === "function") {
          reduceMotionQuery.addEventListener("change", updateMotionPreference);
        } else if (typeof reduceMotionQuery.addListener === "function") {
          reduceMotionQuery.addListener(updateMotionPreference);
        }
      }
      function shouldReduceMotion() {
        return prefersReducedMotion;
      }
      function getAnimationLevel() {
        if (shouldReduceMotion()) return "none";
        const hardwareThreads =
          typeof navigator !== "undefined" && navigator.hardwareConcurrency
            ? navigator.hardwareConcurrency
            : 4;
        const isSmallViewport =
          typeof window !== "undefined" &&
          (window.innerWidth <= 640 || window.innerHeight <= 480);
        if (isSmallViewport || hardwareThreads <= 4) {
          return "light";
        }
        return "full";
      }
      function getAnimationConfig() {
        const level = getAnimationLevel();
        const base = {
          level,
          effectDuration: LATIHAN_EFFECT_DURATION,
          overlayDuration: 950,
          softHighlightDuration: 650,
          confettiParticles: 30,
          celebrationDuration: 1900,
          celebrationPieces: 40,
        };
        if (level === "light") {
          return {
            ...base,
            effectDuration: 750,
            overlayDuration: 800,
            confettiParticles: 18,
            celebrationDuration: 1400,
            celebrationPieces: 26,
          };
        }
        if (level === "none") {
          return {
            ...base,
            effectDuration: 0,
            overlayDuration: 0,
            softHighlightDuration: 600,
            confettiParticles: 0,
            celebrationDuration: 0,
            celebrationPieces: 0,
          };
        }
        return base;
      }
      const DOM = {};
      function cacheDOMElements() {
        DOM.loadingScreen = document.getElementById("loadingScreen");
        DOM.startQuizModal = document.getElementById("startQuizModal");
        DOM.startQuizModalContent = document.getElementById(
          "startQuizModalContent"
        );
        DOM.quizTitle = document.getElementById("quiz-title");
        DOM.quizQuestionCount = document.getElementById("quiz-question-count");
        DOM.quizDuration = document.getElementById("quiz-duration");
        DOM.startQuizBtn = document.getElementById("startQuizBtn");
        DOM.modeRadios = document.querySelectorAll('input[name="quiz-mode"]');
        DOM.quizWrapper = document.getElementById("quiz-wrapper");
        DOM.quizContainer = document.getElementById("quiz-container");
        DOM.nomorSoalContainer = document.getElementById(
          "nomor-soal-container"
        );
        DOM.quizContainerMobile = document.getElementById(
          "quiz-container-mobile"
        );
        DOM.nomorSoalContainerMobile = document.getElementById(
          "nomor-soal-container-mobile"
        );
        DOM.minutes = document.getElementById("minutes");
        DOM.seconds = document.getElementById("seconds");
        DOM.timerMobile = document.getElementById("timer-mobile");
        DOM.allTimers = document.querySelectorAll("#timer, #timer-mobile");
        DOM.allLiveScores = document.querySelectorAll(
          "#live-score, #live-score-mobile"
        );
        DOM.allLiveScoreContainers = document.querySelectorAll(
          "#live-score-container, #live-score-container-mobile"
        );
        DOM.allQuestionTitles = document.querySelectorAll(
          "#nomor-soal-judul, #nomor-soal-judul-mobile"
        );
        DOM.allQuestionTexts = document.querySelectorAll(
          "#teks-soal, #teks-soal-mobile"
        );
        DOM.allOptionContainers = document.querySelectorAll(
          "#pilihan-container, #pilihan-container-mobile"
        );
        DOM.allFeedbackContainers = document.querySelectorAll(
          "#feedback-container, #feedback-container-mobile"
        );
        DOM.allActionContainers = document.querySelectorAll(
          "#action-container, #action-container-mobile"
        );
        DOM.modalHasil = document.getElementById("modal-hasil");
      }
      function setupModeSelector() {
        if (modeSelectionInitialized || !DOM.modeRadios) return;
        modeSelectionInitialized = true;
        Array.from(DOM.modeRadios).forEach((radio) => {
          radio.addEventListener("change", (event) => {
            if (event.target.checked) {
              handleModeChange(event.target.value);
            }
          });
        });
      }
      function handleModeChange(mode) {
        quizMode = mode === MODE_LATIHAN ? MODE_LATIHAN : MODE_UJIAN;
        updateModeUI();
      }
      function updateModeUI() {
        if (DOM.quizDuration) {
          DOM.quizDuration.textContent =
            quizMode === MODE_LATIHAN
              ? "Tanpa Durasi"
              : formatDuration(duration);
        }
        if (DOM.startQuizBtn) {
          DOM.startQuizBtn.disabled = false;
          DOM.startQuizBtn.textContent =
            quizMode === MODE_LATIHAN ? "Mulai Latihan" : "Mulai Sekarang";
        }
      }
      function applyModeUIState() {
        if (!DOM.allTimers || !DOM.allLiveScoreContainers) return;
        if (quizMode === MODE_LATIHAN) {
          DOM.allTimers.forEach((el) => {
            if (el) el.style.display = "none";
          });
          DOM.allLiveScoreContainers.forEach((el) => {
            if (el) el.style.display = "";
          });
        } else {
          DOM.allTimers.forEach((el) => {
            if (el) el.style.display = "";
          });
          DOM.allLiveScoreContainers.forEach((el) => {
            if (el) el.style.display = "none";
          });
        }
      }
      async function initQuiz() {
        token = window.location.search.substring(1);
        const navigationEntries = performance.getEntriesByType("navigation");
        if (
          navigationEntries.length > 0 &&
          navigationEntries[0].type === "reload"
        ) {
          try {
            const tokenDataStr = localStorage.getItem(`quiz_token_${token}`);
            if (tokenDataStr) {
              tokenData = {
                data: JSON.parse(tokenDataStr),
              };
            }
          } catch (e) {
            tokenData = null;
          }
          clearQuizState(token);
          try {
            localStorage.removeItem(`quiz_token_${token}`);
          } catch (e) {}
          showSecurityError(
            "Sesi Anda telah berakhir karena memuat ulang halaman. Silakan mulai kembali dari menu utama."
          );
          DOM.loadingScreen.style.opacity = "0";
          setTimeout(() => DOM.loadingScreen.classList.add("hidden"), 500);
          return;
        }
        if (!token) {
          showSecurityError(
            "Token tidak ditemukan di URL. Silakan akses kuis dari menu utama."
          );
          DOM.loadingScreen.style.opacity = "0";
          setTimeout(() => DOM.loadingScreen.classList.add("hidden"), 500);
          return;
        }
        const loadedState = loadQuizState(token);
        if (loadedState && loadedState.startTime && loadedState.dataSoal) {
          tokenData = securityManager.validateToken(token);
          if (!tokenData.valid) {
            clearQuizState(token);
            showSecurityError(tokenData.reason);
            DOM.loadingScreen.style.opacity = "0";
            setTimeout(() => DOM.loadingScreen.classList.add("hidden"), 500);
            return;
          }
          Object.assign(window, loadedState);
          quizMode = loadedState.quizMode || MODE_UJIAN;
          await loadMathJax();
          startActualQuiz();
          DOM.loadingScreen.style.opacity = "0";
          setTimeout(() => DOM.loadingScreen.classList.add("hidden"), 500);
          return;
        }
        try {
          tokenData = securityManager.validateToken(token);
          if (!tokenData.valid) {
            showSecurityError(tokenData.reason);
            DOM.loadingScreen.style.opacity = "0";
            setTimeout(() => DOM.loadingScreen.classList.add("hidden"), 500);
            return;
          }

          const {
            packageId,
            testType,
            duration: tokenDuration,
            questionCount,
          } = tokenData.data;
          const resultKey = `quiz_result_${securityManager.sessionId}_${testType}_${packageId}`;
          const savedResult = localStorage.getItem(resultKey);

          if (savedResult) {
            try {
              const resultData = JSON.parse(savedResult);
              soalSekarang = resultData.soalSekarang;
              jawabanPengguna = resultData.jawabanPengguna;
              jawabanKompleks = resultData.jawabanKompleks;
              jawabanSingkat = resultData.jawabanSingkat;
              correctStatus = resultData.correctStatus;
              dataSoal = resultData.dataSoal;
              quizMode = resultData.quizMode || MODE_UJIAN;

              await loadMathJax();
              tampilkanHasilUjian(
                resultData.totalBenar,
                resultData.totalSalah,
                resultData.totalKosong,
                resultData.totalRagu,
                resultData.skorAkhir
              );
              DOM.loadingScreen.style.opacity = "0";
              setTimeout(() => DOM.loadingScreen.classList.add("hidden"), 500);
              return;
            } catch (e) {
              console.error("Gagal memuat hasil kuis tersimpan:", e);
            }
          }

          await loadMathJax();
          const filePath = `./${testType}.json?v=0.1.2.4`;
          const response = await fetch(filePath);
          if (!response.ok)
            throw new Error(
              `Gagal memuat file soal: ${filePath} (${response.statusText})`
            );
          const materiJson = await response.json();
          console.log(`Mencari paket: ${packageId}`);
          console.log(`Total paket tersedia: ${materiJson.paket_soal?.length || 0}`);
          const selectedPaket = materiJson.paket_soal.find(
            (p) => p.id === packageId
          );
          if (!selectedPaket) {
            console.error(`Paket ${packageId} tidak ditemukan. Paket yang tersedia:`,
              materiJson.paket_soal.map(p => p.id).slice(0, 10));
            throw new Error(
              `Paket soal dengan ID "${packageId}" tidak ditemukan.`
            );
          }
          console.log(`✓ Paket ditemukan: ${selectedPaket.nama}`);
          if (selectedPaket.soal.length !== questionCount)
            throw new Error("Jumlah soal dalam data tidak cocok dengan token.");
          dataSoal = { ...selectedPaket, durasi: tokenDuration * 60 };
          document.title = `${dataSoal.nama} | bisadanedu`;
          const questionIndices = Array.from(
            {
              length: dataSoal.soal.length,
            },
            (_, i) => i
          );
          const randomizedIndices = shuffleArray(questionIndices);
          soalSekarang = randomizedIndices.map((originalIndex) => {
            const soal = sanitizeQuestionData(dataSoal.soal[originalIndex]);
            if (soal.type === "complex" || soal.type === "short_answer") {
              return { ...soal, originalIndex };
            }
            const choices = soal.pilihan.map((text) => ({
              text: text,
            }));
            return {
              ...soal,
              originalIndex,
              shuffledChoices: shuffleArray(choices),
            };
          });
          const numQuestions = soalSekarang.length;
          jawabanPengguna = new Array(numQuestions).fill(null);
          jawabanKompleks = new Array(numQuestions).fill(null);
          jawabanSingkat = new Array(numQuestions).fill(null);
          submittedStatus = new Array(numQuestions).fill(false);
          raguRaguStatus = new Array(numQuestions).fill(false);
          correctStatus = new Array(numQuestions).fill(null);
          liveScore = 0;
          startTime = null;
          duration = dataSoal.durasi;
          quizMode = MODE_UJIAN;
          prepareStartModal();
        } catch (error) {
          console.error("Initialization error:", error);
          showQuestionSetError();
        } finally {
          DOM.loadingScreen.style.opacity = "0";
          setTimeout(() => DOM.loadingScreen.classList.add("hidden"), 500);
        }
      }
      function formatDuration(seconds) {
        if (!seconds || seconds <= 0) {
          return "Tanpa Durasi";
        }
        const totalMinutes = Math.ceil(seconds / 60);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        const parts = [];
        if (hours > 0) {
          parts.push(`${hours} Jam`);
        }
        if (minutes > 0) {
          parts.push(`${minutes} Menit`);
        }
        if (parts.length === 0) {
          return "1 Menit";
        }
        return parts.join(" ");
      }
      function prepareStartModal() {
        if (!DOM.startQuizBtn || !DOM.startQuizModal) {
          startActualQuiz();
          return;
        }
        if (DOM.quizWrapper) {
          DOM.quizWrapper.classList.add("hidden");
        }
        if (DOM.quizTitle) {
          DOM.quizTitle.textContent =
            dataSoal && dataSoal.nama ? dataSoal.nama : "Kuis";
        }
        if (DOM.quizQuestionCount) {
          DOM.quizQuestionCount.textContent = `${soalSekarang.length} Soal`;
        }
        setupModeSelector();

        const isMobile = window.innerWidth < 640;
        if (DOM.modeRadios && DOM.modeRadios.length) {
          if (isMobile) {
            Array.from(DOM.modeRadios).forEach((radio) => {
              radio.checked = false;
            });
            DOM.startQuizBtn.disabled = true;
          } else {
            Array.from(DOM.modeRadios).forEach((radio) => {
              radio.checked = radio.value === quizMode;
            });
            DOM.startQuizBtn.disabled = false;
            updateModeUI();
          }
        } else {
          DOM.startQuizBtn.disabled = false;
          updateModeUI();
        }
        DOM.startQuizBtn.onclick = () => {
          DOM.startQuizBtn.disabled = true;
          startActualQuiz();
        };
        showStartModal();
      }
      function showStartModal() {
        if (!DOM.startQuizModal || !DOM.startQuizModalContent) return;
        DOM.startQuizModalContent.classList.remove("show");
        DOM.startQuizModal.classList.remove("hidden");
        DOM.startQuizModal.classList.add("flex");
        DOM.startQuizModalContent.scrollTop = 0;
        requestAnimationFrame(() => {
          DOM.startQuizModalContent.classList.add("show");
        });
        document.body.classList.add("overflow-hidden");
      }
      function closeStartModal() {
        if (!DOM.startQuizModal || !DOM.startQuizModalContent) {
          document.body.classList.remove("overflow-hidden");
          return;
        }
        DOM.startQuizModalContent.classList.remove("show");
        setTimeout(() => {
          DOM.startQuizModal.classList.add("hidden");
          DOM.startQuizModal.classList.remove("flex");
        }, 300);
        document.body.classList.remove("overflow-hidden");
      }
      function startActualQuiz() {
        closeStartModal();
        document.body.classList.remove("overflow-hidden");
        DOM.quizWrapper.classList.remove("hidden");
        setupUI();
        if (intervalTimer) {
          clearInterval(intervalTimer);
        }
        intervalTimer = null;
        if (quizMode === MODE_UJIAN) {
          if (!startTime) {
            startTime = Date.now();
          }
          startTimer();
        } else {
          startTime = null;
        }
        applyModeUIState();
        tampilkanSoal(nomorSoalAktif);
        updateLiveScoreUI(false);
        saveQuizState(token);
      }
      function setupUI() {
        DOM.nomorSoalContainer.innerHTML = "";
        const fragment = document.createDocumentFragment();
        soalSekarang.forEach((_, index) => {
          const button = document.createElement("button");
          button.className =
            "question-number w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-sm";
          button.textContent = index + 1;
          button.onclick = () => pindahKeSoal(index);
          fragment.appendChild(button);
        });
        DOM.nomorSoalContainer.appendChild(fragment);
        questionNumberButtons = Array.from(DOM.nomorSoalContainer.children);
        document
          .getElementById("zoom-in-btn")
          .addEventListener("click", zoomIn);
        document
          .getElementById("zoom-out-btn")
          .addEventListener("click", zoomOut);
        DOM.nomorSoalContainerMobile.innerHTML =
          DOM.nomorSoalContainer.innerHTML;
        questionNumberButtonsMobile = Array.from(
          DOM.nomorSoalContainerMobile.children
        );
        questionNumberButtonsMobile.forEach((btn, index) => {
          btn.onclick = () => pindahKeSoal(index);
        });
        document
          .getElementById("zoom-in-btn-mobile")
          .addEventListener("click", zoomIn);
        document
          .getElementById("zoom-out-btn-mobile")
          .addEventListener("click", zoomOut);
        updateNavigationButtons();
      }
      function tampilkanSoal(index) {
        const soal = soalSekarang[index];
        const isSubmitted = submittedStatus[index];
        DOM.allQuestionTitles.forEach(
          (el) => (el.textContent = `Soal ${index + 1}`)
        );
        DOM.allQuestionTexts.forEach((el) => {
          el.innerHTML = soal.pertanyaan || "Pertanyaan tidak tersedia.";
          el.querySelectorAll("table").forEach((table) => {
            const wrapper = document.createElement("div");
            wrapper.className = "table-wrapper";
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
            table.classList.add("styled-table");
          });
        });
        DOM.allFeedbackContainers.forEach((el) => (el.innerHTML = ""));
        DOM.allActionContainers.forEach((el) => (el.innerHTML = ""));
        DOM.allOptionContainers.forEach((container) => {
          container.innerHTML = "";
          switch (soal.type) {
            case "complex":
              renderComplexQuestion(soal, index, container, isSubmitted);
              break;
            case "short_answer":
              renderShortAnswerQuestion(soal, index, container, isSubmitted);
              break;
            default:
              renderMultipleChoice(soal, index, container, isSubmitted);
              break;
          }
          renderMathInElement(container);
        });
        DOM.allActionContainers.forEach((container) => {
          renderActionButtons(index, container);
        });
        if (quizMode === MODE_LATIHAN) {
          if (submittedStatus[index]) {
            const result = checkAnswer(index);
            renderAnswerFeedback(index, result);
          } else {
            clearFeedbackDisplay(index);
          }
          updateConfirmButtonState(index);
        } else {
          clearFeedbackDisplay(index);
        }
        applyZoom();
        updateActiveQuestionIndicator();
        scrollToActiveQuestion();
        DOM.allQuestionTexts.forEach((el) => renderMathInElement(el));
      }
      function renderMultipleChoice(soal, index, container, isSubmitted) {
        const fragment = document.createDocumentFragment();
        const isMultipleSelect = isMultipleSelectQuestion(soal);
        const isLocked = quizMode === MODE_LATIHAN && isSubmitted;
        const correctAnswers = isMultipleSelect
          ? getMultipleSelectCorrectAnswers(soal)
          : [soal.jawaban];
        const correctNormalized = isMultipleSelect
          ? new Set(correctAnswers.map((ans) => normalizeText(ans)))
          : normalizeText(correctAnswers[0]);
        const userAnswerRaw = jawabanPengguna[index];
        const userSelections = Array.isArray(userAnswerRaw)
          ? userAnswerRaw
          : userAnswerRaw
            ? [userAnswerRaw]
            : [];
        const userNormalized = new Set(
          userSelections.map((ans) => normalizeText(ans))
        );
        if (isMultipleSelect) {
          const note = document.createElement("p");
          note.className = "text-sm text-slate-500 italic mb-3";
          note.textContent = "Pilih semua jawaban yang benar.";
          fragment.appendChild(note);
        }
        soal.shuffledChoices.forEach((pilihan) => {
          const button = document.createElement("button");
          button.className = `option-button w-full text-left p-4 rounded-xl flex items-start gap-4 bg-white`;
          button.type = "button";
          button.dataset.originalText = pilihan.text;
          button.innerHTML = `
<div class="option-checkbox flex-shrink-0" aria-hidden="true"></div>
<span class="option-text flex-1 text-base leading-relaxed text-slate-800">${pilihan.text}</span>
          `.trim();
          const pilihanText = pilihan.text;
          const normalizedChoice = normalizeText(pilihanText);
          if (!isLocked) {
            button.onclick = function () {
              if (isMultipleSelect) {
                toggleMultipleSelectAnswer(index, pilihanText);
              } else {
                pilihJawaban(index, pilihanText);
              }
            };
          }
          const isSelected = isMultipleSelect
            ? userNormalized.has(normalizedChoice)
            : jawabanPengguna[index] === pilihan.text;
          if (isSelected) {
            button.classList.add("selected");
          }
          if (isLocked) {
            button.disabled = true;
            button.classList.add("option-button--locked");
            button.setAttribute("aria-disabled", "true");
            button.tabIndex = -1;
          }
          fragment.appendChild(button);
        });
        container.appendChild(fragment);
      }
      function renderShortAnswerQuestion(soal, index, container, isSubmitted) {
        const currentAnswer = jawabanSingkat[index] || "";
        const isLocked = quizMode === MODE_LATIHAN && isSubmitted;
        const inputWrapper = document.createElement("div");
        inputWrapper.className = "relative";
        inputWrapper.innerHTML = `<input type="text" id="short-answer-input-${container.id}" class="w-full p-4 text-slate-800 bg-white rounded-xl border-2 border-slate-300 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all duration-200 text-lg" placeholder="Ketik jawaban Anda..." value="${currentAnswer}" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><p class="text-sm text-slate-500 mt-3 ml-1">Jawaban tidak membedakan huruf besar/kecil & spasi.</p>`;
        const input = inputWrapper.querySelector("input");
        if (isLocked) {
          input.disabled = true;
          input.classList.add("short-answer-locked");
          input.setAttribute("aria-disabled", "true");
        } else {
          input.oninput = (e) => {
            jawabanSingkat[index] = e.target.value;
            refreshActionAvailability(index);
            saveQuizState(token);
          };
        }
        container.appendChild(inputWrapper);
      }
      function renderComplexQuestion(soal, index, container, isSubmitted) {
        const isLocked = quizMode === MODE_LATIHAN && isSubmitted;
        if (!jawabanKompleks[index]) {
          jawabanKompleks[index] = new Array(soal.pernyataan.length).fill(null);
        }
        const userAnswers = jawabanKompleks[index];
        const tableContainer = document.createElement("div");
        tableContainer.className =
          "overflow-x-auto border border-slate-200 rounded-xl custom-scrollbar";
        const table = document.createElement("table");
        table.className = "w-full min-w-full text-sm text-left text-slate-500";
        table.innerHTML = `
        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
          <tr>
            <th scope="col" class="px-6 py-3 text-left w-2/5 whitespace-normal">Pernyataan</th>
            ${soal.pilihan.map((p) => `<th scope="col" class="px-6 py-3 text-center">${p}</th>`).join("")}
          </tr>
        </thead>
        <tbody>
          ${soal.pernyataan
            .map(
              (statement, sIndex) => `
          <tr class="bg-white border-b border-slate-200 last:border-b-0">
            <td class="px-6 py-4 font-medium text-slate-900 whitespace-normal">${statement}</td>
            ${soal.pilihan
              .map((_, oIndex) => {
                const isChecked = userAnswers[sIndex] === oIndex;
                let cellClass =
                  "bg-slate-100 border-slate-300 hover:bg-slate-200";
                let checkmark = "";
                if (isChecked) {
                  cellClass = "bg-blue-600 border-blue-700";
                  checkmark = `<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                }
                const clickHandler = isLocked
                  ? ""
                  : `onclick="selectComplexAnswer(${index}, ${sIndex}, ${oIndex})"`;
                const lockedClass = isLocked ? " complex-option-locked" : "";
                const ariaDisabledAttr = isLocked
                  ? ' aria-disabled="true"'
                  : "";
                return `
              <td class="px-6 py-4 text-center">
                <div ${clickHandler} class="w-6 h-6 mx-auto flex items-center justify-center rounded-md cursor-pointer transition-all ${cellClass} border${lockedClass}"${ariaDisabledAttr}>
                  ${checkmark}
                </div>
              </td>
            `;
              })
              .join("")}
          </tr>
        `
            )
            .join("")}
        </tbody>`;
        tableContainer.appendChild(table);
        container.appendChild(tableContainer);
      }
      function syncRaguToggleUI(index) {
        const containers = Array.from(DOM.allActionContainers || []);
        const isActive = !!raguRaguStatus[index];
        containers.forEach((container) => {
          if (!container) return;
          container
            .querySelectorAll(`.ragu-toggle-label[data-ragu-index="${index}"]`)
            .forEach((label) => {
              label.classList.toggle("ragu-toggle-label--active", isActive);
              label.setAttribute("aria-pressed", String(isActive));
            });
          container
            .querySelectorAll(`input[data-ragu-index="${index}"]`)
            .forEach((checkbox) => {
              checkbox.checked = isActive;
            });
        });
      }
      function createRaguToggle(index, containerId) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex-1 text-center";
        const checkboxId = `ragu-ragu-check-${containerId}-${index}`;
        const raguCheckbox = document.createElement("input");
        raguCheckbox.type = "checkbox";
        raguCheckbox.id = checkboxId;
        raguCheckbox.className = "sr-only";
        raguCheckbox.dataset.raguIndex = String(index);
        const raguLabel = document.createElement("label");
        raguLabel.htmlFor = checkboxId;
        raguLabel.className = "ragu-toggle-label";
        raguLabel.dataset.raguIndex = String(index);
        raguLabel.textContent = "Ragu-ragu";
        raguLabel.tabIndex = 0;
        raguLabel.setAttribute("role", "button");
        const applyLocalState = () => {
          const isActive = !!raguRaguStatus[index];
          raguCheckbox.checked = isActive;
          raguLabel.classList.toggle("ragu-toggle-label--active", isActive);
          raguLabel.setAttribute("aria-pressed", String(isActive));
        };
        applyLocalState();
        const toggleCheckbox = () => {
          raguCheckbox.checked = !raguCheckbox.checked;
          raguCheckbox.dispatchEvent(new Event("change", { bubbles: true }));
        };
        raguLabel.addEventListener("click", (event) => {
          event.preventDefault();
          toggleCheckbox();
        });
        raguLabel.addEventListener("keydown", (event) => {
          if (event.key === " " || event.key === "Enter") {
            event.preventDefault();
            toggleCheckbox();
          }
        });
        raguLabel.addEventListener("focus", () => {
          raguLabel.classList.add("ragu-toggle-label--focus");
        });
        raguLabel.addEventListener("blur", () => {
          raguLabel.classList.remove("ragu-toggle-label--focus");
        });
        raguCheckbox.addEventListener("change", () => {
          raguRaguStatus[index] = raguCheckbox.checked;
          applyLocalState();
          syncRaguToggleUI(index);
          updateQuestionState(index, raguCheckbox.checked, false);
          saveQuizState(token);
        });
        wrapper.append(raguCheckbox, raguLabel);
        return wrapper;
      }
      function renderActionButtons(index, container) {
        container.innerHTML = "";
        const actionWrapper = document.createElement("div");
        actionWrapper.className =
          "action-controls" +
          (quizMode === MODE_LATIHAN ? " action-controls--latihan" : "");
        const prevButton = document.createElement("button");
        prevButton.title = "Soal Sebelumnya";
        prevButton.className =
          "w-14 h-14 flex items-center justify-center bg-white border-2 border-slate-200 rounded-full transition-all duration-200 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed";
        prevButton.classList.add("action-control-button", "action-btn-prev");
        prevButton.innerHTML = `<svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>`;
        prevButton.onclick = () => navigasiSoal(-1);
        if (index === 0) {
          prevButton.disabled = true;
        }
        const raguRaguWrapper = createRaguToggle(
          index,
          container.id || "action"
        );
        const nextButton = document.createElement("button");
        nextButton.title = "Soal Selanjutnya";
        nextButton.className =
          "w-14 h-14 flex items-center justify-center bg-blue-600 text-white rounded-full transition-all duration-200 hover:bg-blue-700 shadow-lg shadow-blue-500/30";
        nextButton.classList.add("action-control-button", "action-btn-next");
        nextButton.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>`;
        if (index === soalSekarang.length - 1) {
          nextButton.onclick = () => showConfirmModal();
        } else {
          nextButton.onclick = () => navigasiSoal(1);
        }
        if (quizMode === MODE_LATIHAN) {
          const centerWrapper = document.createElement("div");
          centerWrapper.className = "latihan-action-stack";
          const confirmButton = document.createElement("button");
          confirmButton.type = "button";
          confirmButton.className = "confirm-button";
          confirmButton.dataset.questionIndex = index;
          confirmButton.textContent = "Konfirmasi Jawaban";
          confirmButton.onclick = () => konfirmasiJawaban(index);
          centerWrapper.append(confirmButton);
          prevButton.style.order = "1";
          centerWrapper.style.order = "2";
          nextButton.style.order = "3";
          actionWrapper.append(prevButton, centerWrapper, nextButton);
        } else {
          actionWrapper.append(prevButton, raguRaguWrapper, nextButton);
        }
        container.appendChild(actionWrapper);
        updateConfirmButtonState(index);
      }
      function clearFeedbackDisplay(index) {
        if (
          typeof index === "number" &&
          typeof nomorSoalAktif === "number" &&
          index !== nomorSoalAktif
        ) {
          return;
        }
        if (!DOM.allFeedbackContainers) return;
        DOM.allFeedbackContainers.forEach((container) => {
          if (container) container.innerHTML = "";
        });
      }
      function updateConfirmButtonState(index) {
        if (quizMode !== MODE_LATIHAN || !DOM.allActionContainers) return;
        const canConfirm = isQuestionAnswered(index);
        const isSubmitted = submittedStatus[index];
        const score = correctStatus[index];
        const isCorrect = score === 1;
        const isPartial = typeof score === "number" && score > 0 && score < 1;
        DOM.allActionContainers.forEach((container) => {
          const buttons = container.querySelectorAll(".confirm-button");
          if (!buttons.length) return;
          buttons.forEach((btn) => {
            const btnIndexRaw = btn.dataset.questionIndex;
            const btnIndex =
              btnIndexRaw !== undefined ? parseInt(btnIndexRaw, 10) : NaN;
            if (!Number.isNaN(btnIndex) && btnIndex !== index) return;
            btn.disabled = !canConfirm;
            btn.setAttribute("aria-disabled", String(btn.disabled));
            btn.classList.remove(
              "confirm-button--primary",
              "confirm-button--success",
              "confirm-button--warning",
              "confirm-button--danger"
            );
            if (!isSubmitted) {
              btn.textContent = "Konfirmasi Jawaban";
              btn.classList.add("confirm-button--primary");
            } else if (isCorrect) {
              btn.textContent = "Jawaban Benar";
              btn.classList.add("confirm-button--success");
            } else if (isPartial) {
              btn.textContent = "Sebagian Benar";
              btn.classList.add("confirm-button--warning");
            } else {
              btn.textContent = "Jawaban Salah";
              btn.classList.add("confirm-button--danger");
            }
          });
        });
      }
      function rerenderQuestionOptions(index) {
        const soal = soalSekarang[index];
        if (!soal || !DOM.allOptionContainers) return;
        const isSubmitted = submittedStatus[index];
        DOM.allOptionContainers.forEach((container) => {
          if (!container) return;
          container.innerHTML = "";
          switch (soal.type) {
            case "complex":
              renderComplexQuestion(soal, index, container, isSubmitted);
              break;
            case "short_answer":
              renderShortAnswerQuestion(soal, index, container, isSubmitted);
              break;
            default:
              renderMultipleChoice(soal, index, container, isSubmitted);
              break;
          }
          renderMathInElement(container);
        });
      }
      function renderAnswerFeedback(index, result) {
        if (quizMode !== MODE_LATIHAN || !DOM.allFeedbackContainers) return;
        const soal = soalSekarang[index];
        if (!soal) return;
        const explanationHTML = createPembahasanHTML(soal);
        const statusScore = typeof result.score === "number" ? result.score : 0;
        let statusInfo = {
          title: "Jawaban Belum Tepat",
          cardClass: "latihan-feedback-card--danger",
          iconWrapClass:
            "latihan-feedback-card__icon latihan-feedback-card__icon--danger",
          titleClass:
            "latihan-feedback-card__title latihan-feedback-card__title--danger",
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
        };
        if (result.isCorrect) {
          statusInfo = {
            title: "Jawaban Benar",
            cardClass: "latihan-feedback-card--success",
            iconWrapClass:
              "latihan-feedback-card__icon latihan-feedback-card__icon--success",
            titleClass:
              "latihan-feedback-card__title latihan-feedback-card__title--success",
            icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>`,
          };
        } else if (statusScore > 0 && statusScore < 1) {
          statusInfo = {
            title: "Sebagian Benar",
            cardClass: "latihan-feedback-card--warning",
            iconWrapClass:
              "latihan-feedback-card__icon latihan-feedback-card__icon--warning",
            titleClass:
              "latihan-feedback-card__title latihan-feedback-card__title--warning",
            icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/></svg>`,
          };
        }
        const partialInfo =
          statusScore > 0 && statusScore < 1
            ? `<p class="latihan-feedback-card__note">Skor ${Math.round(
                statusScore * 100
              )}%</p>`
            : "";
        const feedbackHTML = `
          <div class="latihan-feedback-card ${statusInfo.cardClass}">
            <div class="latihan-feedback-card__header">
              <div class="${statusInfo.iconWrapClass}">
                ${statusInfo.icon}
              </div>
              <div>
                <p class="${statusInfo.titleClass}">${statusInfo.title}</p>
                ${partialInfo}
              </div>
            </div>
            <div class="latihan-feedback-card__body">
              <div class="latihan-feedback-card__section latihan-feedback-card__section--solution">
                <h4 class="latihan-feedback-card__section-title">Kunci Jawaban</h4>
                <div class="latihan-feedback-card__section-text pembahasan-math-wrapper">${result.correctAnswerText || "<em>Tidak tersedia</em>"}</div>
              </div>
              ${
                explanationHTML
                  ? `<div class="latihan-feedback-card__section latihan-feedback-card__section--explain overflow-x-auto">
                      <h4 class="latihan-feedback-card__section-title">Pembahasan</h4>
                      <div class="latihan-feedback-card__section-text pembahasan-math-wrapper">${explanationHTML}</div>
                    </div>`
                  : ""
              }
            </div>
          </div>
        `;
        DOM.allFeedbackContainers.forEach((container) => {
          if (!container) return;
          container.innerHTML = feedbackHTML;
          renderMathInElement(container);
        });
      }
      function konfirmasiJawaban(index) {
        if (quizMode !== MODE_LATIHAN) return;
        if (!isQuestionAnswered(index)) {
          alert("Silakan pilih jawaban terlebih dahulu.");
          return;
        }
        const result = checkAnswer(index);
        submittedStatus[index] = true;
        correctStatus[index] = result.score;
        renderAnswerFeedback(index, result);
        triggerLatihanAnswerEffect(result);
        rerenderQuestionOptions(index);
        updateQuestionState(
          index,
          raguRaguStatus[index] || false,
          result.isCorrect
        );
        updateConfirmButtonState(index);
        updateLiveScoreUI(true);
        saveQuizState(token);
      }
      function triggerLatihanAnswerEffect(result) {
        if (quizMode !== MODE_LATIHAN || !result) return;
        const animationConfig = getAnimationConfig();
        const score =
          typeof result.score === "number" && !Number.isNaN(result.score)
            ? result.score
            : 0;
        const isPartial = !result.isCorrect && score > 0 && score < 1;
        const effectTargets = [
          DOM.quizWrapper,
          DOM.quizContainer,
          DOM.quizContainerMobile,
        ].filter(
          (element, index, array) =>
            element && array.indexOf(element) === index
        );
        const variant = result.isCorrect
          ? "success"
          : isPartial
            ? "partial"
            : "danger";
        if (animationConfig.level === "none") {
          effectTargets.forEach((element) =>
            applyLatihanStaticHighlight(
              element,
              variant,
              animationConfig.softHighlightDuration
            )
          );
          return;
        }
        if (result.isCorrect) {
          spawnLatihanCelebrationOverlay(animationConfig);
          spawnLatihanConfetti(
            animationConfig.confettiParticles,
            animationConfig
          );
          effectTargets.forEach((element) =>
            applyLatihanEffectClass(
              element,
              "latihan-result-pop",
              animationConfig.effectDuration
            )
          );
        } else if (isPartial) {
          effectTargets.forEach((element) =>
            applyLatihanEffectClass(
              element,
              "latihan-result-pulse",
              animationConfig.effectDuration + 150
            )
          );
        } else {
          if (animationConfig.overlayDuration > 0) {
            spawnLatihanDangerOverlay(animationConfig.overlayDuration);
          }
          effectTargets.forEach((element) =>
            applyLatihanEffectClass(
              element,
              "latihan-result-danger-frame",
              animationConfig.effectDuration + 100
            )
          );
        }
      }
      function applyLatihanEffectClass(element, className, duration) {
        if (!element) return;
        element.classList.remove(className);
        void element.offsetWidth;
        if (typeof window !== "undefined" && window.requestAnimationFrame) {
          window.requestAnimationFrame(() => {
            element.classList.add(className);
          });
        } else {
          element.classList.add(className);
        }
        const resolvedDuration =
          typeof duration === "number" && duration > 0
            ? duration
            : LATIHAN_EFFECT_DURATION;
        window.setTimeout(() => {
          element.classList.remove(className);
        }, resolvedDuration);
      }
      function applyLatihanStaticHighlight(element, variant, lifespan) {
        if (!element) return;
        const className = LATIHAN_STATIC_HIGHLIGHTS[variant];
        if (!className) return;
        element.classList.remove(className);
        void element.offsetWidth;
        if (typeof window !== "undefined" && window.requestAnimationFrame) {
          window.requestAnimationFrame(() => {
            element.classList.add(className);
          });
        } else {
          element.classList.add(className);
        }
        const timeout =
          typeof lifespan === "number" && lifespan > 0 ? lifespan : 600;
        window.setTimeout(() => {
          element.classList.remove(className);
        }, timeout);
      }
      function spawnLatihanCelebrationOverlay(animationConfig) {
        if (shouldReduceMotion()) return;
        const existingOverlay = document.querySelector(
          ".latihan-celebrate-overlay"
        );
        if (existingOverlay) {
          existingOverlay.remove();
        }
        const overlay = document.createElement("div");
        overlay.className = "latihan-celebrate-overlay";
        const level = animationConfig?.level || "full";
        const pieceTarget =
          typeof animationConfig?.celebrationPieces === "number"
            ? animationConfig.celebrationPieces
            : 38;
        const pieceCount = Math.round(
          Math.min(
            Math.max(pieceTarget, level === "light" ? 14 : 22),
            level === "light" ? 48 : 72
          )
        );
        const minDuration = level === "light" ? 0.9 : 1.15;
        const maxDuration = level === "light" ? 1.2 : 1.6;
        const maxDelay = level === "light" ? 0.16 : 0.28;
        const colorPalette = [
          "#3b82f6",
          "#a855f7",
          "#f97316",
          "#facc15",
          "#22c55e",
          "#ef4444",
          "#ec4899",
          "#38bdf8",
        ];
        for (let i = 0; i < pieceCount; i++) {
          const paper = document.createElement("span");
          paper.className = "latihan-celebrate-overlay__paper";
          const width = 8 + Math.random() * 10;
          const height = width * (1.4 + Math.random() * 0.8);
            const radius = Math.random() * 6;
            const startOffset = Math.random() * 180 - 90;
            const endOffset = startOffset + (Math.random() * 220 - 110);
            const rotateStart = (Math.random() * 120 - 60).toFixed(1);
            const rotateEnd =
              Number(rotateStart) + (Math.random() * 720 - 360);
            const duration =
              minDuration + Math.random() * (maxDuration - minDuration);
            const delay = Math.random() * maxDelay;
            const color =
              colorPalette[Math.floor(Math.random() * colorPalette.length)];
            paper.style.setProperty("--paper-width", `${width.toFixed(1)}px`);
            paper.style.setProperty("--paper-height", `${height.toFixed(1)}px`);
            paper.style.setProperty("--paper-radius", `${radius.toFixed(1)}px`);
          paper.style.setProperty("--paper-color", color);
          paper.style.setProperty("--paper-start-x", `${startOffset.toFixed(1)}px`);
          paper.style.setProperty("--paper-end-x", `${endOffset.toFixed(1)}px`);
          paper.style.setProperty(
            "--paper-rotate-start",
            `${rotateStart}deg`
          );
          paper.style.setProperty(
            "--paper-rotate-end",
            `${rotateEnd.toFixed(1)}deg`
          );
          paper.style.setProperty("--paper-duration", `${duration.toFixed(3)}s`);
          paper.style.setProperty("--paper-delay", `${delay.toFixed(3)}s`);
          overlay.appendChild(paper);
        }
        document.body.appendChild(overlay);
        const lifespan =
          typeof animationConfig?.celebrationDuration === "number" &&
          animationConfig.celebrationDuration > 0
            ? animationConfig.celebrationDuration
            : 1700;
        window.setTimeout(() => {
          overlay.remove();
        }, lifespan);
      }
      function spawnLatihanConfetti(particleOverride, animationConfig) {
        if (shouldReduceMotion()) return;
        const existingOverlay = document.querySelector(".latihan-anim-overlay");
        if (existingOverlay) {
          existingOverlay.remove();
        }
        const overlay = document.createElement("div");
        overlay.className = "latihan-anim-overlay";
        const intensity = animationConfig?.level || "full";
        const particleTotal =
          typeof particleOverride === "number" && particleOverride >= 0
            ? particleOverride
            : 26;
        if (particleTotal <= 0) return;
        const baseDuration = intensity === "full" ? 0.9 : 0.8;
        const randomDuration = intensity === "full" ? 0.5 : 0.35;
        const scaleBase = intensity === "full" ? 0.85 : 0.75;
        const scaleRange = intensity === "full" ? 0.6 : 0.45;
        const sizeBase = intensity === "full" ? 10 : 9;
        const sizeRange = intensity === "full" ? 10 : 8;
        const driftRange = intensity === "full" ? 180 : 120;
        const removalDelay =
          intensity === "full"
            ? 1800
            : intensity === "light"
              ? 1500
              : 1300;
        for (let i = 0; i < particleTotal; i++) {
          const particle = document.createElement("span");
          particle.className = "latihan-anim-overlay__particle";
          const hue = Math.floor(Math.random() * 360);
          const secondaryHue = (hue + 40) % 360;
          const delay = Math.random() * 0.2;
          const duration = baseDuration + Math.random() * randomDuration;
          const scale = (scaleBase + Math.random() * scaleRange).toFixed(2);
          const size = sizeBase + Math.random() * sizeRange;
          const drift = (Math.random() - 0.5) * driftRange;
          const startRotation = Math.random() * 360;
          const endRotation = startRotation + (Math.random() * 360 + 180);
          const leftPosition = Math.random() * 100;
          particle.style.setProperty("--delay", `${delay}s`);
          particle.style.setProperty("--duration", `${duration}s`);
          particle.style.setProperty("--scale", scale);
          particle.style.setProperty("--size", `${size}px`);
          particle.style.setProperty("--drift", `${drift}px`);
          particle.style.setProperty("--start-rotation", `${startRotation}deg`);
          particle.style.setProperty("--end-rotation", `${endRotation}deg`);
          particle.style.left = `${leftPosition}%`;
          particle.style.background = `linear-gradient(135deg, hsl(${hue}, 95%, 65%), hsl(${secondaryHue}, 85%, 55%))`;
          overlay.appendChild(particle);
        }
        document.body.appendChild(overlay);
        window.setTimeout(() => {
          overlay.remove();
        }, removalDelay);
      }
      function spawnLatihanDangerOverlay(duration) {
        if (shouldReduceMotion()) return;
        const existingDanger = document.querySelector(".latihan-danger-overlay");
        if (existingDanger) {
          existingDanger.remove();
        }
        const overlay = document.createElement("div");
        overlay.className = "latihan-danger-overlay";
        document.body.appendChild(overlay);
        window.setTimeout(() => {
          overlay.remove();
        }, typeof duration === "number" && duration > 0 ? duration : 950);
      }
      function createPembahasanHTML(soal) {
        const penjelasan = soal.penjelasan;
        if (!penjelasan) return "";
        if (soal.type === "complex" && penjelasan.includes("||")) {
          const parts = penjelasan.split("||");
          return parts
            .map(
              (part) =>
                `<div class="border-l-2 border-slate-200/80 pl-4 py-1 mb-3 last:mb-0"><p>${part.replace(/\\n/g, "<br>")}</p></div>`
            )
            .join("");
        } else {
          return `<div class="leading-relaxed">${penjelasan.replace(/\\n/g, "<br>")}</div>`;
        }
      }
      function isQuestionAnswered(index) {
        const soal = soalSekarang[index];
        if (!soal) return false;
        if (soal.type === "complex") {
          return (
            jawabanKompleks[index] &&
            jawabanKompleks[index].every((ans) => ans !== null)
          );
        } else if (soal.type === "short_answer") {
          return jawabanSingkat[index] && jawabanSingkat[index].trim() !== "";
        } else if (isMultipleSelectQuestion(soal)) {
          const userAnswer = jawabanPengguna[index];
          if (Array.isArray(userAnswer)) {
            return userAnswer.length > 0;
          }
          if (typeof userAnswer === "string") {
            return userAnswer.trim() !== "";
          }
          return false;
        } else {
          return jawabanPengguna[index] !== null;
        }
      }
      function syncOptionButtonSelections(indexSoal) {
        const userAnswer = jawabanPengguna[indexSoal];
        DOM.allOptionContainers.forEach((container) => {
          container.querySelectorAll(".option-button").forEach((btn) => {
            const originalText = btn.dataset.originalText;
            if (!originalText) return;
            const shouldSelect = Array.isArray(userAnswer)
              ? userAnswer.some((ans) => ans === originalText)
              : userAnswer === originalText;
            if (shouldSelect) btn.classList.add("selected");
            else btn.classList.remove("selected");
          });
        });
      }
      function refreshActionAvailability(indexSoal) {
        submittedStatus[indexSoal] = false;
        if (quizMode === MODE_LATIHAN) {
          correctStatus[indexSoal] = null;
          if (indexSoal === nomorSoalAktif) {
            clearFeedbackDisplay(indexSoal);
          }
        }
        updateAnsweredStatus(indexSoal);
        updateQuestionState(
          indexSoal,
          raguRaguStatus[indexSoal] || false,
          false
        );
        if (quizMode === MODE_LATIHAN) {
          updateConfirmButtonState(indexSoal);
          if (indexSoal === nomorSoalAktif) {
            updateLiveScoreUI(false);
          }
        }
      }
      function toggleMultipleSelectAnswer(indexSoal, jawabanTeks) {
        if (quizMode === MODE_LATIHAN && submittedStatus[indexSoal]) {
          return;
        }
        const currentRaw = jawabanPengguna[indexSoal];
        const selections = Array.isArray(currentRaw)
          ? [...currentRaw]
          : currentRaw
            ? [currentRaw]
            : [];
        const normalizedTarget = normalizeText(jawabanTeks);
        const existingIndex = selections.findIndex(
          (ans) => normalizeText(ans) === normalizedTarget
        );
        if (existingIndex >= 0) {
          selections.splice(existingIndex, 1);
        } else {
          selections.push(jawabanTeks);
        }
        jawabanPengguna[indexSoal] = selections.length ? selections : null;
        syncOptionButtonSelections(indexSoal);
        refreshActionAvailability(indexSoal);
        saveQuizState(token);
      }
      function pilihJawaban(indexSoal, jawabanTeks) {
        if (quizMode === MODE_LATIHAN && submittedStatus[indexSoal]) {
          return;
        }
        const soal = soalSekarang[indexSoal];
        if (isMultipleSelectQuestion(soal)) {
          toggleMultipleSelectAnswer(indexSoal, jawabanTeks);
          return;
        }
        jawabanPengguna[indexSoal] = jawabanTeks;
        syncOptionButtonSelections(indexSoal);
        refreshActionAvailability(indexSoal);
        saveQuizState(token);
      }
      function selectComplexAnswer(questionIndex, statementIndex, optionIndex) {
        if (quizMode === MODE_LATIHAN && submittedStatus[questionIndex]) {
          return;
        }
        if (!jawabanKompleks[questionIndex]) {
          jawabanKompleks[questionIndex] = new Array(
            soalSekarang[questionIndex].pernyataan.length
          ).fill(null);
        }
        jawabanKompleks[questionIndex][statementIndex] = optionIndex;
        DOM.allOptionContainers.forEach((container) => {
          const table = container.querySelector("table");
          if (!table) return;
          const row = table.querySelectorAll("tbody tr")[statementIndex];
          if (!row) return;
          row.querySelectorAll("td").forEach((cell, cellIndex) => {
            if (cellIndex > 0) {
              const div = cell.querySelector("div");
              div.innerHTML = "";
              div.classList.remove("bg-blue-600", "border-blue-700");
              div.classList.add(
                "bg-slate-100",
                "border-slate-300",
                "hover:bg-slate-200"
              );
            }
          });
          const selectedCell = row.querySelectorAll("td")[optionIndex + 1];
          if (selectedCell) {
            const div = selectedCell.querySelector("div");
            div.classList.add("bg-blue-600", "border-blue-700");
            div.classList.remove(
              "bg-slate-100",
              "border-slate-300",
              "hover:bg-slate-200"
            );
            div.innerHTML = `<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
          }
        });
        refreshActionAvailability(questionIndex);
        saveQuizState(token);
      }
      function updateAnsweredStatus(index) {
        const buttons = [
          questionNumberButtons[index],
          questionNumberButtonsMobile[index],
        ];
        const isAnswered = isQuestionAnswered(index);
        buttons.forEach((btn) => {
          if (!btn) return;
          if (isAnswered && !raguRaguStatus[index] && !submittedStatus[index]) {
            btn.classList.add("answered");
          } else {
            btn.classList.remove("answered");
          }
        });
      }
      function updateQuestionState(indexSoal, isRagu, isCorrect) {
        const buttons = [
          questionNumberButtons[indexSoal],
          questionNumberButtonsMobile[indexSoal],
        ];
        buttons.forEach((btn) => {
          if (!btn) return;
          btn.classList.remove(
            "ragu",
            "answered-correct",
            "answered-incorrect",
            "answered"
          );
          if (isRagu) {
            btn.classList.add("ragu");
          } else if (isQuestionAnswered(indexSoal)) {
            btn.classList.add("answered");
          }
          if (submittedStatus[indexSoal]) {
            btn.classList.remove("ragu", "answered");
            if (isCorrect) {
              btn.classList.add("answered-correct");
            } else {
              btn.classList.add("answered-incorrect");
            }
          }
        });
      }
      function updateActiveQuestionIndicator() {
        if (questionNumberButtons[prevActiveButtonIndex]) {
          questionNumberButtons[prevActiveButtonIndex].classList.remove(
            "active"
          );
          questionNumberButtonsMobile[prevActiveButtonIndex].classList.remove(
            "active"
          );
        }
        if (questionNumberButtons[nomorSoalAktif]) {
          questionNumberButtons[nomorSoalAktif].classList.add("active");
          questionNumberButtonsMobile[nomorSoalAktif].classList.add("active");
        }
        prevActiveButtonIndex = nomorSoalAktif;
      }
      function updateNavigationButtons() {
        questionNumberButtons.forEach((btn) => (btn.disabled = false));
        questionNumberButtonsMobile.forEach((btn) => (btn.disabled = false));
      }
      function navigasiSoal(arah) {
        const newIndex = nomorSoalAktif + arah;
        if (newIndex >= 0 && newIndex < soalSekarang.length) {
          pindahKeSoal(newIndex);
        }
      }
      function pindahKeSoal(index) {
        nomorSoalAktif = index;
        saveQuizState(token);
        tampilkanSoal(index);
        if (window.innerWidth < 1024) {
          window.scrollTo({
            top: 0,
            behavior: "smooth",
          });
        } else {
          const questionPanel = document.getElementById("teks-soal");
          if (questionPanel)
            questionPanel.scrollTo({
              top: 0,
              behavior: "smooth",
            });
          const answerPanel =
            document.getElementById("pilihan-container")?.parentElement;
          if (answerPanel)
            answerPanel.scrollTo({
              top: 0,
              behavior: "smooth",
            });
        }
      }
      function scrollToActiveQuestion() {
        const desktopNavContainer = document.querySelector(
          "#quiz-container aside .custom-scrollbar"
        );
        if (desktopNavContainer) {
          const activeIndicator = desktopNavContainer.querySelector(
            ".question-number.active"
          );
          if (activeIndicator) {
            activeIndicator.scrollIntoView({
              behavior: "smooth",
              block: "center",
            });
          }
        }
        const mobileNavContainer = document.querySelector(
          "#quiz-container-mobile .question-nav-scrollbar"
        );
        if (mobileNavContainer) {
          const activeIndicator = mobileNavContainer.querySelector(
            ".question-number.active"
          );
          if (activeIndicator) {
            const containerRect = mobileNavContainer.getBoundingClientRect();
            const activeRect = activeIndicator.getBoundingClientRect();
            const scrollPosition =
              activeIndicator.offsetLeft -
              containerRect.width / 2 +
              activeRect.width / 2;
            mobileNavContainer.scrollTo({
              left: scrollPosition,
              behavior: "smooth",
            });
          }
        }
      }
      function startTimer() {
        if (!startTime) return;
        intervalTimer = setInterval(() => {
          const remaining = Math.max(
            0,
            duration - Math.floor((Date.now() - startTime) / 1000)
          );
          updateTimerDisplay(remaining);
          if (remaining <= 0) {
            clearInterval(intervalTimer);
            selesaiQuiz();
          }
        }, 1000);
      }
      function updateTimerDisplay(remaining) {
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        const minStr = minutes.toString().padStart(2, "0");
        const secStr = seconds.toString().padStart(2, "0");
        DOM.minutes.textContent = minStr;
        DOM.seconds.textContent = secStr;
        if (DOM.timerMobile) {
          DOM.timerMobile.innerHTML =
            document.getElementById("timer").innerHTML;
        }
        DOM.allTimers.forEach((timerEl) => {
          timerEl.classList.toggle("timer-critical", remaining <= 60);
          timerEl.classList.toggle("text-red-600", remaining <= 60);
          timerEl.classList.toggle("bg-red-100", remaining <= 60);
          timerEl.classList.toggle("font-extrabold", remaining <= 60);
        });
      }
      function updateLiveScoreUI(animate) {
        const totalScorePoints = correctStatus.reduce(
          (sum, score) => sum + (score || 0),
          0
        );
        const totalSoal = soalSekarang.length;
        const skala = dataSoal.skala_penilaian || 100;
        const currentScore =
          totalSoal > 0 ? (totalScorePoints / totalSoal) * skala : 0;
        DOM.allLiveScores.forEach(
          (el) => (el.textContent = Math.round(currentScore))
        );
        if (animate) {
          DOM.allLiveScoreContainers.forEach((el) => {
            el.classList.add("score-update");
            el.addEventListener(
              "animationend",
              () => {
                el.classList.remove("score-update");
              },
              {
                once: true,
              }
            );
          });
        }
      }
      function selesaiQuiz() {
        clearInterval(intervalTimer);
        submittedStatus.fill(true);
        correctStatus = soalSekarang.map((_, i) => checkAnswer(i).score);
        let totalBenar = 0,
          totalSalah = 0,
          totalKosong = 0;
        const totalRagu = raguRaguStatus.filter(Boolean).length;
        correctStatus.forEach((score, index) => {
          if (!isQuestionAnswered(index)) {
            totalKosong++;
          } else if (score === 1) {
            totalBenar++;
          } else {
            totalSalah++;
          }
        });
        const totalSoal = soalSekarang.length;
        const skala = dataSoal.skala_penilaian || 100;
        const totalScorePoints = correctStatus.reduce(
          (sum, score) => sum + (score || 0),
          0
        );
        const skorAkhir =
          totalSoal > 0
            ? Math.round((totalScorePoints / totalSoal) * skala)
            : 0;
        securityManager.markTokenAsCompleted(token);

        const { testType, packageId } = tokenData.data;
        const resultKey = `quiz_result_${securityManager.sessionId}_${testType}_${packageId}`;

        const resultData = {
          totalBenar,
          totalSalah,
          totalKosong,
          totalRagu,
          skorAkhir,
          soalSekarang,
          jawabanPengguna,
          jawabanKompleks,
          jawabanSingkat,
          correctStatus,
          dataSoal,
          quizMode,
        };
        try {
          localStorage.setItem(resultKey, JSON.stringify(resultData));
        } catch (e) {
          console.error("Gagal menyimpan hasil kuis:", e);
        }

        clearQuizState(token);
        const scoreKey = `skor_${testType}_${packageId}`;
        try {
          const existingScore = localStorage.getItem(scoreKey);
          if (!existingScore || skorAkhir > parseInt(existingScore, 10)) {
            localStorage.setItem(scoreKey, skorAkhir.toString());
          }
        } catch (e) {}
        const resultArgs = [
          totalBenar,
          totalSalah,
          totalKosong,
          totalRagu,
          skorAkhir,
        ];
        tampilkanHasilUjian(...resultArgs);
      }
      function getMotivationalMessage(score, scale) {
        const percentage = (score / scale) * 100;
        if (percentage >= 90)
          return {
            text: "Luar Biasa!",
            color: "text-amber-300",
          };
        if (percentage >= 75)
          return {
            text: "Kerja Bagus!",
            color: "text-green-300",
          };
        if (percentage >= 60)
          return {
            text: "Bagus!",
            color: "text-blue-300",
          };
        return {
          text: "Terus Berlatih!",
          color: "text-slate-300",
        };
      }
      function isDarkThemeActive() {
        if (document.documentElement.classList.contains("dark")) {
          return true;
        }
        if (window.matchMedia) {
          try {
            return window.matchMedia("(prefers-color-scheme: dark)").matches;
          } catch (error) {}
        }
        return false;
      }
      function syncLogoTheme(rootElement) {
        const scope = rootElement || document;
        const useDarkLogo = isDarkThemeActive();
        scope
          .querySelectorAll("img[data-logo-light][data-logo-dark]")
          .forEach((img) => {
            const desiredSrc = useDarkLogo
              ? img.getAttribute("data-logo-dark")
              : img.getAttribute("data-logo-light");
            if (desiredSrc && img.getAttribute("src") !== desiredSrc) {
              img.setAttribute("src", desiredSrc);
            }
          });
      }
      function formatUserAnswer(answer, index) {
        const soal = soalSekarang[index];
        if (soal.type === "complex") {
          const userAnswers = jawabanKompleks[index] || [];
          let tableHTML = `
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full min-w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left w-1/2 statement-cell">Pernyataan</th>
                            ${soal.pilihan.map((p) => `<th scope="col" class="px-6 py-3 text-center">${p}</th>`).join("")}
                        </tr>
                    </thead>
                    <tbody>
            `;
          soal.pernyataan.forEach((statement, sIndex) => {
            tableHTML += `<tr class="bg-white border-b border-slate-200 last:border-b-0">
                                        <td class="px-6 py-4 font-medium text-slate-900 statement-cell">${statement}</td>`;
            if (
              userAnswers[sIndex] === null ||
              userAnswers[sIndex] === undefined
            ) {
              tableHTML += `<td class="px-6 py-4 text-center italic text-slate-400" colspan="${soal.pilihan.length}">Tidak dijawab</td>`;
            } else {
              soal.pilihan.forEach((_, oIndex) => {
                const isChecked = userAnswers[sIndex] === oIndex;
                const cellContent = isChecked
                  ? `<div class="w-5 h-5 mx-auto flex items-center justify-center rounded-md bg-blue-600">
                                     <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                  </div>`
                  : "";
                tableHTML += `<td class="px-6 py-4 text-center">${cellContent}</td>`;
              });
            }
            tableHTML += `</tr>`;
          });
          tableHTML += `</tbody></table></div>`;
          return tableHTML;
        }
        if (isMultipleSelectQuestion(soal)) {
          const answers = Array.isArray(answer)
            ? answer
            : answer
              ? [answer]
              : [];
          return formatAnswersList(answers, {
            emphasize: false,
            emptyPlaceholder: "<em>Tidak dijawab</em>",
          });
        }
        if (soal.type === "short_answer") {
          return `<strong>${answer || "<em>Tidak dijawab</em>"}</strong>`;
        }
        if (Array.isArray(answer)) {
          return formatAnswersList(answer, {
            emphasize: false,
            emptyPlaceholder: "<em>Tidak dijawab</em>",
          });
        }
        return answer || "<em>Tidak dijawab</em>";
      }
      function buildComplexSummaryHTML(soal, userAnswersRaw) {
        const userAnswers = Array.isArray(userAnswersRaw) ? userAnswersRaw : [];
        const rows = soal.pernyataan
          .map((statement, sIndex) => {
            const correctIdx = soal.jawaban[sIndex];
            const correctText =
              soal.pilihan?.[correctIdx] !== undefined
                ? soal.pilihan[correctIdx]
                : "";
            const userIdx = userAnswers[sIndex];
            const hasUser = userIdx !== null && userIdx !== undefined;
            const isCorrect = hasUser && userIdx === correctIdx;
            const userStatusClass = hasUser
              ? isCorrect
                ? "user-cell-correct"
                : "user-cell-wrong"
              : "user-cell-neutral";
            const userResponseHTML =
              hasUser && soal.pilihan?.[userIdx] !== undefined
                ? `<span class="user-response ${
                    isCorrect ? "user-response-correct" : "user-response-wrong"
                  }">${soal.pilihan[userIdx]}</span>`
                : `<span class="user-response user-response-empty"><em>Belum dijawab</em></span>`;
            const statusBadge = hasUser
              ? ""
              : '<span class="complex-status-badge badge-neutral">Belum</span>';
            return `
              <tr>
                <td class="statement-cell pembahasan-math-wrapper">${statement}</td>
                <td class="user-cell">
                  <div class="user-cell-inner ${userStatusClass}">
                    <div class="user-response-wrapper">
                      ${userResponseHTML}
                    </div>
                    ${statusBadge}
                  </div>
                </td>
                <td class="answer-cell pembahasan-math-wrapper"><strong>${correctText}</strong></td>
              </tr>
            `;
          })
          .join("");
        return `
          <div class="complex-summary-table-wrapper">
            <table class="complex-summary-table">
              <thead>
                <tr>
                  <th scope="col">Pernyataan</th>
                  <th scope="col">Jawaban Anda</th>
                  <th scope="col">Kunci</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        `;
      }
      function showPembahasan(selectedIndex) {
        const allCards = document.querySelectorAll(".pembahasan-card-desktop");
        allCards.forEach((card) => {
          card.classList.add("hidden");
        });
        const selectedCard = document.getElementById(
          `pembahasan-card-desktop-${selectedIndex}`
        );
        if (selectedCard) {
          selectedCard.classList.remove("hidden");
        }
        const allNavButtons = document.querySelectorAll(".navigator-btn");
        allNavButtons.forEach((btn) => {
          btn.classList.remove("navigator-active");
        });
        const selectedNavButton = document.getElementById(
          `navigator-btn-${selectedIndex}`
        );
        if (selectedNavButton) {
          selectedNavButton.classList.add("navigator-active");
        }
      }
      function renderDonutChart(canvasId, benar, salah, kosong) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Benar", "Salah", "Kosong"],
            datasets: [
              {
                label: "Hasil Kuis",
                data: [benar, salah, kosong],
                backgroundColor: ["#22c55e", "#ef4444", "#a1a1aa"],
                borderColor: ["#ffffff", "#ffffff", "#ffffff"],
                borderWidth: 3,
                hoverOffset: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%",
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.label || "";
                    if (label) {
                      label += ": ";
                    }
                    if (context.parsed !== null) {
                      label += context.parsed;
                    }
                    return label;
                  },
                },
              },
            },
          },
        });
      }
      function redoQuiz() {
        if (tokenData && tokenData.data) {
          const { testType, packageId } = tokenData.data;
          const resultKey = `quiz_result_${securityManager.sessionId}_${testType}_${packageId}`;
          const tokenKey = `quiz_token_${token}`;

          try {
            // 1. Remove the saved result
            localStorage.removeItem(resultKey);

            // 2. Reset the token to be usable again
            const tokenDataStr = localStorage.getItem(tokenKey);
            if (tokenDataStr) {
              const storedTokenData = JSON.parse(tokenDataStr);
              storedTokenData.used = false; // Reset the 'used' flag
              delete storedTokenData.usedAt; // Remove the timestamp
              localStorage.setItem(tokenKey, JSON.stringify(storedTokenData));
            }

            // 3. Remove the old quiz session state if it exists
            localStorage.removeItem(getSessionKey(token));
          } catch (e) {
            console.error(
              "Gagal menghapus data kuis untuk pengerjaan ulang:",
              e
            );
            alert(
              "Gagal menghapus data tersimpan. Coba bersihkan cache browser Anda."
            );
            return;
          }
          // 4. Navigate to the same URL to re-initialize the quiz
          window.location.href = window.location.href;
        } else {
          alert(
            "Sesi tidak valid untuk memulai ulang. Anda akan diarahkan ke menu utama."
          );
          goToHome();
        }
      }
      function tampilkanHasilUjian(
        totalBenar,
        totalSalah,
        totalKosong,
        totalRagu,
        skorAkhir
      ) {
        const skala = dataSoal.skala_penilaian || 100;
        const quizTitle = dataSoal.nama || "Kuis";
        const { text: message, color: messageColor } = getMotivationalMessage(
          skorAkhir,
          skala
        );
        const mobileHTML = `
        <div class="w-full h-full flex flex-col bg-slate-100 overflow-y-auto question-nav-scrollbar">
            <aside class="w-full flex-shrink-0">
                <div class="result-bg relative text-white text-center py-10 sm:py-12 px-4 overflow-hidden">
                    <div class="absolute top-4 right-4 flex gap-2">
                        <button onclick="redoQuiz()" class="bg-white/20 hover:bg-white/30 text-white font-semibold py-2 px-4 rounded-full transition-all duration-300 inline-flex items-center gap-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                            </svg>
                            <span class="hidden sm:inline">Kerjakan Ulang</span>
                        </button>
                        <button onclick="goToHome()" class="bg-white/20 hover:bg-white/30 text-white font-semibold py-2 px-4 rounded-full transition-all duration-300 inline-flex items-center gap-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M11.47 3.841a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.061l-8.689-8.69a2.25 2.25 0 0 0-3.182 0l-8.69 8.69a.75.75 0 1 0 1.061 1.06l8.69-8.689Z" /><path d="m12 5.432 8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198a2.29 2.29 0 0 0 .091-.086L12 5.432Z" /></svg>
                            <span class="hidden sm:inline">Menu Utama</span>
                        </button>
                    </div>
                    <div class="relative z-10 mt-[70px]">
                        <h2 class="text-2xl font-bold text-white mt-1 mb-4 px-4">${quizTitle}</h2>
                        <div class="score-display">
                            <p id="animated-score" class="text-8xl font-black tracking-tighter text-white" style="text-shadow: 0 4px 20px rgba(0,0,0,0.2);">${skorAkhir}</p>
                            <p class="text-xl font-bold mt-2 ${messageColor}">${message}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-100 -mt-8 rounded-t-3xl relative z-20 p-4 sm:p-6 pb-12">
                    <div class="max-w-md mx-auto">
                        <h2 class="text-xl font-bold text-slate-800 text-center mb-6">Ringkasan Pengerjaan</h2>
                        <div class="bg-white p-4 rounded-2xl shadow-md space-y-3">
                            <div class="detail-item flex items-center" style="animation-delay: 100ms;"><div class="w-10 h-10 flex-shrink-0 bg-green-100 rounded-lg flex items-center justify-center mr-4"><svg class="w-6 h-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><div class="flex-1"><p class="font-semibold text-slate-700">Jawaban Benar</p></div><div class="text-xl font-bold text-green-600">${totalBenar}</div></div>
                            <div class="detail-item flex items-center" style="animation-delay: 200ms;"><div class="w-10 h-10 flex-shrink-0 bg-red-100 rounded-lg flex items-center justify-center mr-4"><svg class="w-6 h-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></div><div class="flex-1"><p class="font-semibold text-slate-700">Jawaban Salah</p></div><div class="text-lg font-bold text-red-600">${totalSalah}</div></div>
                            <div class="detail-item flex items-center" style="animation-delay: 300ms;"><div class="w-10 h-10 flex-shrink-0 bg-yellow-100 rounded-lg flex items-center justify-center mr-4"><svg class="w-6 h-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="flex-1"><p class="font-semibold text-slate-700">Ragu-ragu</p></div><div class="text-lg font-bold text-yellow-600">${totalRagu}</div></div>
                            <div class="detail-item flex items-center" style="animation-delay: 400ms;"><div class="w-10 h-10 flex-shrink-0 bg-slate-200 rounded-lg flex items-center justify-center mr-4"><svg class="w-6 h-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="flex-1"><p class="font-semibold text-slate-700">Tidak Dijawab</p></div><div class="text-lg font-bold text-slate-600">${totalKosong}</div></div>
                        </div>
                    </div>
                </div>
            </aside>
            <section class="w-full flex-grow flex flex-col">
                <header class="sticky top-0 backdrop-blur-lg border-b border-slate-200 p-4 sm:p-6 z-10 flex-shrink-0">
                    <h2 class="text-xl sm:text-2xl font-bold text-slate-800">Pembahasan</h2>
                </header>
                <div class="p-4 sm:p-6">
                    <div class="space-y-4">
                        ${generatePembahasanHTMLMobile()}
                    </div>
                </div>
            </section>
        </div>
        `;
        const desktopHTML = `
        <div class="w-full h-full bg-slate-50 flex flex-col">
            <header class="w-full flex flex-row bg-white border-b border-slate-200 flex-shrink-0 z-10 items-center">
                <div class="w-3/12 xl:w-1/4 p-4 flex items-center justify-start border-r border-slate-200">
<img src="../../img/bisadanedu_logo_terang.png?v=2" alt="Logo" class="h-9 object-contain" data-logo-light="../../img/bisadanedu_logo_terang.png?v=2" data-logo-dark="../../img/bisadanedu_logo_gelap.png?v=2" onerror="this.onerror=null; this.src='https://placehold.co/130x40/3b82f6/white?text=Logo';">
                </div>
                <div class="w-6/12 xl:w-1/2 p-4 border-r border-slate-200">
                    <h2 class="text-xl font-bold text-slate-800 text-center">${quizTitle}</h2>
                </div>
                <div class="w-3/12 xl:w-1/4 p-4 flex items-center justify-center gap-2">
                    <button onclick="redoQuiz()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg transition-all duration-300 inline-flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                        <span>Ulangi</span>
                    </button>
                    <button onclick="goToHome()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 inline-flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M11.47 3.841a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.061l-8.689-8.69a2.25 2.25 0 0 0-3.182 0l-8.69 8.69a.75.75 0 1 0 1.061 1.06l8.69-8.689Z" /><path d="m12 5.432 8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198a2.29 2.29 0 0 0 .091-.086L12 5.432Z" /></svg>
                        <span>Menu</span>
                    </button>
                </div>
            </header>
            <div class="w-full flex-1 flex flex-row min-h-0">
                <aside class="w-3/12 xl:w-1/4 h-full flex flex-col bg-white border-r border-slate-200">
                    <div class="flex-1 flex flex-col items-center justify-start p-4 text-center">
                        <div class="score-display w-full max-w-[200px] mx-auto">
                            <div class="relative w-full aspect-square">
                                <canvas id="resultChartDesktop"></canvas>
                                <div id="animated-score-container" class="absolute inset-0 flex flex-col items-center justify-center text-center">
                                    <p id="animated-score-desktop" class="text-5xl font-black tracking-tighter text-blue-600">0</p>
                                    <p class="text-sm font-semibold text-slate-500">Skor Akhir</p>
                                </div>
                            </div>
                            <p class="text-xl font-bold mt-3 text-slate-700">${message}</p>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-200 flex-shrink-0">
                        <h3 class="font-bold text-slate-800 mb-4 text-center">Ringkasan</h3>
                        <div class="space-y-3">
                            <div class="detail-item flex items-center bg-green-50 p-3 rounded-lg" style="animation-delay: 100ms;"><div class="w-8 h-8 flex-shrink-0 bg-green-100 rounded-lg flex items-center justify-center mr-3"><svg class="w-5 h-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><p class="font-semibold text-slate-700 text-sm">Benar</p><p class="ml-auto text-lg font-bold text-green-600">${totalBenar}</p></div>
                            <div class="detail-item flex items-center bg-red-50 p-3 rounded-lg" style="animation-delay: 200ms;"><div class="w-8 h-8 flex-shrink-0 bg-red-100 rounded-lg flex items-center justify-center mr-3"><svg class="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></div><p class="font-semibold text-slate-700 text-sm">Salah</p><p class="ml-auto text-lg font-bold text-red-600">${totalSalah}</p></div>
                            <div class="detail-item flex items-center bg-slate-100 p-3 rounded-lg" style="animation-delay: 300ms;"><div class="w-8 h-8 flex-shrink-0 bg-slate-200 rounded-lg flex items-center justify-center mr-3"><svg class="w-5 h-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><p class="font-semibold text-slate-700 text-sm">Kosong</p><p class="ml-auto text-lg font-bold text-slate-600">${totalKosong}</p></div>
                        </div>
                    </div>
                </aside>
                <main class="w-6/12 xl:w-1/2 h-full flex flex-col bg-slate-100 border-r border-slate-200">
                    <div id="pembahasan-container-desktop" class="overflow-y-auto custom-scrollbar p-6">
                        ${generatePembahasanHTMLDesktop()}
                    </div>
                </main>
                <aside class="w-3/12 xl:w-1/4 h-full bg-white flex flex-col">
                        <div class="overflow-y-auto custom-scrollbar p-6">
                            <div class="grid grid-cols-3 xl:grid-cols-4 gap-3">
                                ${generateNavigatorHTML()}
                            </div>
                        </div>
                </aside>
            </div>
        </div>
        `;
        const hasilHTML = `
          <div class="lg:hidden h-full">${mobileHTML}</div>
          <div class="hidden lg:flex h-full">${desktopHTML}</div>
        `;
        DOM.modalHasil.innerHTML = hasilHTML;
        syncLogoTheme(DOM.modalHasil);
        DOM.modalHasil.querySelectorAll("table").forEach((table) => {
          const wrapper = document.createElement("div");
          wrapper.className = "table-wrapper";
          table.parentNode.insertBefore(wrapper, table);
          wrapper.appendChild(table);
          table.classList.add("styled-table");
        });
        setupAccordionListener();
        DOM.modalHasil.classList.remove("hidden");
        DOM.quizWrapper.classList.add("hidden");
        const scoreElement = document.getElementById("animated-score");
        if (scoreElement) animateValue(scoreElement, 0, skorAkhir, 1200);
        const scoreElementDesktop = document.getElementById(
          "animated-score-desktop"
        );
        if (scoreElementDesktop)
          animateValue(scoreElementDesktop, 0, skorAkhir, 1200);
        if (skorAkhir >= 80) triggerConfetti();
        renderDonutChart(
          "resultChartDesktop",
          totalBenar,
          totalSalah,
          totalKosong
        );
        setTimeout(() => {
          renderMathInElement(DOM.modalHasil);
        }, 10);
      }
      function generateNavigatorHTML() {
        let navigatorHTML = "";
        soalSekarang.forEach((_, index) => {
          const isCorrect = correctStatus[index] === 1;
          const isAnswered = isQuestionAnswered(index);
          let buttonClass = "";
          if (isCorrect) {
            buttonClass =
              "bg-green-100 text-green-800 border-green-200 hover:bg-green-200";
          } else if (!isAnswered) {
            buttonClass =
              "bg-slate-100 text-slate-500 border-slate-200 hover:bg-slate-200";
          } else {
            buttonClass =
              "bg-red-100 text-red-800 border-red-200 hover:bg-red-200";
          }
          const isActive = index === 0 ? "navigator-active" : "";
          navigatorHTML += `
                <button id="navigator-btn-${index}" 
                        onclick="showPembahasan(${index})"
                        title="Lihat Soal ${index + 1}"
                        class="navigator-btn w-full aspect-square rounded-lg font-bold flex items-center justify-center transition-all duration-200 border ${buttonClass} ${isActive} transform hover:scale-110">
                    ${index + 1}
                </button>
              `;
        });
        return navigatorHTML;
      }
      function generatePembahasanHTMLMobile() {
        let pembahasanHTML = "";
        soalSekarang.forEach((soal, index) => {
          const { correctAnswerText } = checkAnswer(index);
          const explanationHTML = createPembahasanHTML(soal);
          const userAnswer =
            jawabanPengguna[index] ||
            jawabanSingkat[index] ||
            jawabanKompleks[index];
          const isCorrect = correctStatus[index] === 1;
          const statusClass = isCorrect ? "border-green-500" : "border-red-500";
          const statusIcon = isCorrect
            ? `<svg class="w-6 h-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            : `<svg class="w-6 h-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
          let answerBlocksHTML = "";
          if (isCorrect) {
            answerBlocksHTML = `
                    <div class="p-3 rounded-lg bg-green-100 border border-green-200">
                        <h4 class="font-semibold text-xs text-green-800 mb-1 uppercase tracking-wider">Jawaban Anda (Benar)</h4>
                        <div class="text-xs sm:text-sm text-slate-700 pembahasan-math-wrapper">${formatUserAnswer(userAnswer, index)}</div>
                    </div>
                    `;
          } else {
            answerBlocksHTML = `
                    <div class="p-3 rounded-lg bg-red-100 border border-red-200">
                        <h4 class="font-semibold text-xs text-red-800 mb-1 uppercase tracking-wider">Jawaban Anda</h4>
                        <div class="text-xs sm:text-sm text-slate-700 pembahasan-math-wrapper">${formatUserAnswer(userAnswer, index)}</div>
                    </div>
                    `;
            if (soal.type !== "complex") {
              answerBlocksHTML += `
                            <div class="p-3 rounded-lg bg-green-100 border border-green-200">
                                <h4 class="font-semibold text-xs text-green-800 mb-1 uppercase tracking-wider">Jawaban Benar</h4>
                                <div class="text-xs sm:text-sm text-green-900 font-semibold pembahasan-math-wrapper">${correctAnswerText}</div>
                            </div>
                            `;
            }
            if (soal.type === "complex") {
              const userAns = jawabanKompleks[index] || [];
              answerBlocksHTML = `
                            <div class="p-3 rounded-lg result-summary-box">
                                <h4 class="font-semibold text-xs result-summary-title mb-1 uppercase tracking-wider">Ringkasan Jawaban</h4>
                                <div class="text-xs sm:text-sm space-y-2">${buildComplexSummaryHTML(soal, userAns)}</div>
                            </div>`;
            }
          }
          if (soal.type === "complex") {
            const userAns = jawabanKompleks[index] || [];
            answerBlocksHTML = `
                            <div class="p-3 rounded-lg result-summary-box">
                                <h4 class="font-semibold text-xs result-summary-title mb-1 uppercase tracking-wider">Ringkasan Jawaban</h4>
                                <div class="text-xs sm:text-sm space-y-2">${buildComplexSummaryHTML(soal, userAns)}</div>
                            </div>`;
          }
          pembahasanHTML += `
                <div class="pembahasan-card bg-white rounded-xl shadow-sm border-l-4 ${statusClass} overflow-hidden">
                    <details class="group">
                        <summary class="list-none flex justify-between items-center p-4 sm:p-5 cursor-pointer hover:bg-slate-50 transition">
                            <span class="font-bold text-slate-800">Soal Nomor ${index + 1}</span>
                            <div class="flex items-center gap-3">
                                ${statusIcon}
                                <svg class="w-5 h-5 text-slate-500 transition-transform duration-300 group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                        </summary>
                        <div class="px-4 sm:px-5 pb-5 border-t border-slate-100">
                            <div class="text-sm sm:text-base text-slate-700 leading-relaxed my-4 pembahasan-math-wrapper">${soal.pertanyaan}</div>
                            <div class="mt-4 space-y-3">
                                ${answerBlocksHTML}
                                ${
                                  explanationHTML
                                    ? `
                                <button 
                                    onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.textContent = this.nextElementSibling.style.display === 'none' ? 'Lihat Pembahasan' : 'Sembunyikan Pembahasan'; setTimeout(() => { renderMathInElement(this.nextElementSibling); }, 10);"
                                    class="w-full text-left p-2 mt-3 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-600 text-sm font-semibold transition"
                                >
                                    Lihat Pembahasan
                                </button>
                                <div style="display: none;">
                                    <h4 class="font-semibold text-xs text-blue-600 mt-3 mb-1 uppercase tracking-wider">Pembahasan:</h4>
                                    <div class="text-xs sm:text-sm p-3 rounded-lg result-explanation-box leading-relaxed pembahasan-math-wrapper">${explanationHTML}</div>
                                </div>
                                `
                                    : ""
                                }
                            </div>
                        </div>
                    </details>
                </div>
                `;
        });
        return pembahasanHTML;
      }
      function generatePembahasanHTMLDesktop() {
        let pembahasanHTML = "";
        soalSekarang.forEach((soal, index) => {
          const { correctAnswerText } = checkAnswer(index);
          const explanationHTML = createPembahasanHTML(soal);
          const userAnswer =
            jawabanPengguna[index] ||
            jawabanSingkat[index] ||
            jawabanKompleks[index];
          const isCorrect = correctStatus[index] === 1;
          const statusClass = isCorrect
            ? "border-green-400 bg-green-50/50"
            : "border-red-400 bg-red-50/50";
          const statusTag = isCorrect
            ? `<span class="text-xs font-bold text-green-800 bg-green-200 px-3 py-1 rounded-full">BENAR</span>`
            : `<span class="text-xs font-bold text-red-800 bg-red-200 px-3 py-1 rounded-full">SALAH</span>`;
          const isHidden = index === 0 ? "" : "hidden";
          let answerBlocksHTML = "";
          if (isCorrect) {
            answerBlocksHTML = `
                    <div>
                        <div class="flex items-start gap-3 p-4 rounded-lg bg-green-100 border border-green-200">
                            <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-green-200 text-green-700 mt-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-sm text-green-800">Jawaban Anda (Benar)</h4>
                                <div class="text-base text-slate-800 pembahasan-math-wrapper">${formatUserAnswer(userAnswer, index)}</div>
                            </div>
                        </div>
                    </div>
                    `;
          } else {
            answerBlocksHTML = `
                    <div>
                        <div class="flex items-start gap-3 p-4 rounded-lg bg-red-100 border border-red-200">
                            <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-red-200 text-red-700 mt-1">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                  </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-sm text-red-800">Jawaban Anda</h4>
                                <div class="text-base text-slate-800 pembahasan-math-wrapper">${formatUserAnswer(userAnswer, index)}</div>
                            </div>
                        </div>
                    </div>
                    `;
            if (soal.type !== "complex") {
              answerBlocksHTML += `
                            <div>
                                <div class="flex items-start gap-3 p-4 rounded-lg bg-green-100 border border-green-200">
                                    <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-green-200 text-green-700 mt-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-sm text-green-800">Jawaban Benar</h4>
                                        <div class="text-base text-slate-800 font-semibold pembahasan-math-wrapper">${correctAnswerText}</div>
                                    </div>
                                </div>
                            </div>
                            `;
            }
            if (soal.type === "complex") {
              const userAns = jawabanKompleks[index] || [];
              answerBlocksHTML = `
                            <div>
                                <div class="flex items-start gap-3 p-4 rounded-lg result-summary-box">
                                    <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-blue-200 text-blue-700 mt-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
<path fill-rule="evenodd" d="M8 7a5 5 0 1 1 3.61 4.804l-1.903 1.903A1 1 0 0 1 9 14H8v1a1 1 0 0 1-1 1H6v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-2a1 1 0 0 1 .293-.707L8.196 8.39A5.002 5.002 0 0 1 8 7Zm5-3a.75.75 0 0 0 0 1.5A1.5 1.5 0 0 1 14.5 7 .75.75 0 0 0 16 7a3 3 0 0 0-3-3Z" clip-rule="evenodd" />
</svg>
                                    </div>
                                    <div class="w-full">
                                        <h4 class="font-semibold text-sm result-summary-title">Ringkasan Jawaban</h4>
                                        <div class="mt-2 space-y-2 text-base text-slate-800">
                                            ${buildComplexSummaryHTML(soal, userAns)}
                                        </div>
                                    </div>
                                </div>
                            </div>`;
            }
          }
          pembahasanHTML += `
                <div id="pembahasan-card-desktop-${index}" class="pembahasan-card-desktop bg-white rounded-2xl shadow-sm border ${statusClass} overflow-hidden ${isHidden} transition-all duration-300">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="text-lg font-bold text-slate-800">Soal #${index + 1}</h3>
                            ${statusTag}
                        </div>
                        <div class="text-base text-slate-700 leading-relaxed mb-6 pembahasan-math-wrapper">${soal.pertanyaan}</div>
                        <div class="space-y-4">
                            ${answerBlocksHTML}
                            ${
                              explanationHTML
                                ? `
                            <div class="pt-4 border-t border-slate-200">
                                <h4 class="font-bold text-slate-800 mb-2">Pembahasan:</h4>
                                <div class="text-base text-slate-600 leading-relaxed pembahasan-math-wrapper">${explanationHTML}</div>
                            </div>`
                                : ""
                            }
                        </div>
                    </div>
                </div>
                `;
        });
        return pembahasanHTML;
      }
      function setupAccordionListener() {
        const pembahasanContainer = DOM.modalHasil.querySelector(
          ".lg\\:hidden .space-y-4"
        );
        if (pembahasanContainer) {
          pembahasanContainer.addEventListener(
            "toggle",
            (event) => {
              if (event.target.open) {
                pembahasanContainer
                  .querySelectorAll("details")
                  .forEach((detail) => {
                    if (detail !== event.target) {
                      detail.open = false;
                    }
                  });
                setTimeout(() => {
                  event.target.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                  });
                }, 250);
              }
            },
            true
          );
        }
      }
      function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          obj.innerHTML = Math.floor(progress * (end - start) + start);
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      }
      function triggerConfetti() {
        if (typeof confetti !== "function") {
          const script = document.createElement("script");
          script.src =
            "https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js";
          document.head.appendChild(script);
          script.onload = () => runConfetti();
        } else {
          runConfetti();
        }
      }
      function runConfetti() {
        const duration = 5 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = {
          startVelocity: 30,
          spread: 360,
          ticks: 60,
          zIndex: 100,
        };
        function randomInRange(min, max) {
          return Math.random() * (max - min) + min;
        }
        const interval = setInterval(function () {
          const timeLeft = animationEnd - Date.now();
          if (timeLeft <= 0) {
            return clearInterval(interval);
          }
          const particleCount = 50 * (timeLeft / duration);
          confetti({
            ...defaults,
            particleCount,
            origin: {
              x: randomInRange(0.1, 0.3),
              y: Math.random() - 0.2,
            },
            colors: ["#3b82f6", "#60a5fa", "#93c5fd", "#ffffff"],
          });
          confetti({
            ...defaults,
            particleCount,
            origin: {
              x: randomInRange(0.7, 0.9),
              y: Math.random() - 0.2,
            },
            colors: ["#3b82f6", "#60a5fa", "#93c5fd", "#ffffff"],
          });
        }, 250);
      }
      const letterToNumber = (letter) =>
        letter ? letter.charCodeAt(0) - 65 : -1;
      const normalizeText = (text) => {
        if (!text) return "";

        let normalized = String(text);

        // Normalize Unicode (NFD = Canonical Decomposition, NFC = Canonical Composition)
        if (normalized.normalize) {
          normalized = normalized.normalize('NFKD');
        }

        // Remove all zero-width characters and formatting marks
        normalized = normalized
          .replace(/[\u200B-\u200F]/g, '')  // Zero-width spaces, joiners, LTR/RTL marks
          .replace(/[\u202A-\u202E]/g, '')  // Bidirectional text control
          .replace(/[\u2060-\u2069]/g, '')  // Word joiner, invisible operators
          .replace(/\uFEFF/g, '')           // BOM (Byte Order Mark)
          .replace(/\u00AD/g, '');          // Soft hyphen

        // Normalize all types of spaces to regular space
        normalized = normalized
          .replace(/[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g, ' ')  // All unicode spaces
          .replace(/\s+/g, ' ');            // Collapse multiple spaces

        // Remove control characters (except newline and tab, which will be converted to space)
        normalized = normalized.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');

        // Convert to lowercase and trim
        normalized = normalized.toLowerCase().trim();

        return normalized;
      };

      // Sanitize question data to remove invisible characters
      const sanitizeQuestionData = (soal) => {
        if (!soal) return soal;

        const cleanText = (text) => {
          if (!text) return text;
          if (typeof text !== 'string') return text;

          // Remove invisible characters but keep the original formatting for display
          return text
            .replace(/[\u200B-\u200F]/g, '')
            .replace(/[\u202A-\u202E]/g, '')
            .replace(/[\u2060-\u2069]/g, '')
            .replace(/\uFEFF/g, '')
            .replace(/\u00AD/g, '')
            .replace(/[\u00A0]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
        };

        const sanitized = { ...soal };

        // Clean question text
        if (sanitized.pertanyaan) {
          sanitized.pertanyaan = cleanText(sanitized.pertanyaan);
        }

        // Clean answer options (pilihan)
        if (Array.isArray(sanitized.pilihan)) {
          sanitized.pilihan = sanitized.pilihan.map(cleanText);
        }

        // Clean correct answer (jawaban)
        if (typeof sanitized.jawaban === 'string') {
          sanitized.jawaban = cleanText(sanitized.jawaban);
        } else if (Array.isArray(sanitized.jawaban)) {
          sanitized.jawaban = sanitized.jawaban.map(cleanText);
        }

        // Clean explanation
        if (sanitized.penjelasan) {
          sanitized.penjelasan = cleanText(sanitized.penjelasan);
        }

        // Clean statements for complex questions
        if (Array.isArray(sanitized.pernyataan)) {
          sanitized.pernyataan = sanitized.pernyataan.map(cleanText);
        }

        return sanitized;
      };

      function isMultipleSelectQuestion(soal) {
        return soal && soal.type === "multiple_select";
      }
      function getMultipleSelectCorrectAnswers(soal) {
        if (!isMultipleSelectQuestion(soal)) return [];
        const { jawaban, pilihan = [] } = soal || {};
        const answers = [];
        const seen = new Set();
        const addAnswer = (value) => {
          if (value === null || value === undefined) return;
          const text = String(value).trim();
          if (!text) return;
          const normalized = normalizeText(text);
          if (!normalized || seen.has(normalized)) return;
          seen.add(normalized);
          answers.push(text);
        };
        const addByIndex = (idx) => {
          if (!Array.isArray(pilihan)) return;
          if (Number.isInteger(idx) && idx >= 0 && idx < pilihan.length) {
            const option = pilihan[idx];
            if (option && typeof option === "object") {
              addAnswer(option.text || option.value || option.label);
            } else {
              addAnswer(option);
            }
          }
        };
        if (Array.isArray(jawaban)) {
          jawaban.forEach((item) => {
            if (typeof item === "number") {
              addByIndex(item);
            } else if (typeof item === "string") {
              const trimmed = item.trim();
              if (!trimmed) return;
              if (/^\d+$/.test(trimmed)) {
                addByIndex(parseInt(trimmed, 10));
              } else if (trimmed.length === 1) {
                const idx = letterToNumber(trimmed.toUpperCase());
                if (idx >= 0) addByIndex(idx);
                else addAnswer(trimmed);
              } else {
                addAnswer(trimmed);
              }
            }
          });
        } else if (typeof jawaban === "string") {
          jawaban
            .split(/[,;|]/)
            .map((part) => part.trim())
            .filter(Boolean)
            .forEach((part) => {
              if (/^\d+$/.test(part)) {
                addByIndex(parseInt(part, 10));
              } else if (part.length === 1) {
                const idx = letterToNumber(part.toUpperCase());
                if (idx >= 0) addByIndex(idx);
                else addAnswer(part);
              } else {
                addAnswer(part);
              }
            });
        }
        if (!answers.length && Array.isArray(pilihan)) {
          pilihan.forEach((option) => {
            if (option && typeof option === "object" && option.correct) {
              addAnswer(option.text || option.value || option.label);
            }
          });
        }
        return answers;
      }
      function formatAnswersList(
        answers,
        { emphasize = false, emptyPlaceholder = "<em>Tidak tersedia</em>" } = {}
      ) {
        if (!Array.isArray(answers) || answers.length === 0) {
          return emptyPlaceholder;
        }
        const wrap = (text) => (emphasize ? `<strong>${text}</strong>` : text);
        if (answers.length === 1) {
          return wrap(answers[0]);
        }
        return `<div class="space-y-1">${answers
          .map((ans) => `<div>${wrap(ans)}</div>`)
          .join("")}</div>`;
      }
      // --- Fuzzy matching helpers for short answers ---
      const STOPWORDS_ID = new Set([
        "yang",
        "dan",
        "atau",
        "di",
        "ke",
        "dari",
        "untuk",
        "pada",
        "adalah",
        "itu",
        "ini",
        "dengan",
        "sebagai",
        "karena",
        "bahwa",
        "oleh",
        "dalam",
        "para",
        "seorang",
        "sebuah",
        "tersebut",
      ]);
      const normalizeForSimilarity = (text) => {
        if (!text) return "";
        let s = String(text).toLowerCase().trim();
        // Remove diacritics
        try {
          s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        } catch (e) {}
        // Keep letters and digits, collapse others to space
        s = s
          .replace(/[^a-z0-9]+/g, " ")
          .replace(/\s+/g, " ")
          .trim();
        return s;
      };
      const tokenizeForSimilarity = (text) =>
        normalizeForSimilarity(text)
          .split(" ")
          .filter((t) => t && !STOPWORDS_ID.has(t));
      function jaccardSimilarity(tokensA, tokensB) {
        if (!tokensA.length || !tokensB.length) return 0;
        const setA = new Set(tokensA);
        const setB = new Set(tokensB);
        let intersection = 0;
        for (const t of setA) if (setB.has(t)) intersection++;
        const union = setA.size + setB.size - intersection;
        return union === 0 ? 0 : intersection / union;
      }
      function levenshteinDistance(a, b) {
        const m = a.length,
          n = b.length;
        if (m === 0) return n;
        if (n === 0) return m;
        const dp = new Array(n + 1);
        for (let j = 0; j <= n; j++) dp[j] = j;
        for (let i = 1; i <= m; i++) {
          let prev = dp[0];
          dp[0] = i;
          for (let j = 1; j <= n; j++) {
            const temp = dp[j];
            if (a[i - 1] === b[j - 1]) dp[j] = prev;
            else dp[j] = Math.min(prev + 1, dp[j] + 1, dp[j - 1] + 1);
            prev = temp;
          }
        }
        return dp[n];
      }
      function charSimilarity(a, b) {
        if (!a || !b) return 0;
        const s1 = normalizeForSimilarity(a).replace(/\s+/g, "");
        const s2 = normalizeForSimilarity(b).replace(/\s+/g, "");
        if (!s1 || !s2) return 0;
        const dist = levenshteinDistance(s1, s2);
        const maxLen = Math.max(s1.length, s2.length);
        return maxLen === 0 ? 0 : 1 - dist / maxLen;
      }
      function parseAnswerOptions(ans) {
        if (Array.isArray(ans)) return ans.filter(Boolean);
        if (ans == null) return [];
        const s = String(ans);
        // Split on common separators for alternatives, but avoid '/' to preserve fractions
        return s
          .split(/\s*\|\s*|\s*;\s*|\s+atau\s+/i)
          .map((x) => x.trim())
          .filter(Boolean);
      }
      function isApproxTextMatch(userText, correctText) {
        if (!userText || !correctText) return false;
        // Fast path: exact after legacy normalization
        if (
          normalizeShortAnswer(userText) === normalizeShortAnswer(correctText)
        )
          return true;
        const a = normalizeForSimilarity(userText);
        const b = normalizeForSimilarity(correctText);
        if (!a || !b) return false;
        // Containment check for longer phrases
        const [shorter, longer] = a.length <= b.length ? [a, b] : [b, a];
        if (shorter.length >= 4 && longer.includes(shorter)) return true;
        const tokA = tokenizeForSimilarity(a);
        const tokB = tokenizeForSimilarity(b);
        const jacc = jaccardSimilarity(tokA, tokB);
        if (jacc >= 0.6) return true;
        const charSim = charSimilarity(a, b);
        const minLen = Math.min(a.length, b.length);
        if ((minLen >= 5 && charSim >= 0.84) || (minLen >= 3 && charSim >= 0.9))
          return true;
        return false;
      }
      function evaluateNumericAnswer(str) {
        if (typeof str !== "string" || str.trim() === "") {
          return null;
        }
        str = str.trim().replace(",", ".");
        if (str.includes("/") && !str.match(/[a-zA-Z]/)) {
          const parts = str.split("/");
          if (parts.length === 2) {
            const numerator = parseFloat(parts[0]);
            const denominator = parseFloat(parts[1]);
            if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
              return numerator / denominator;
            }
          }
        }
        const num = parseFloat(str);
        if (!isNaN(num) && isFinite(str)) {
          return num;
        }
        return null;
      }
      function checkAnswer(index) {
        const soal = soalSekarang[index];
        let isCorrect = false;
        let correctAnswerText = "";
        let score = 0;
        if (!isQuestionAnswered(index) && !raguRaguStatus[index]) {
          if (soal.type === "complex") {
            correctAnswerText = soal.pernyataan
              .map(
                (p, i) =>
                  `${p}: <strong>${soal.pilihan[soal.jawaban[i]]}</strong>`
              )
              .join("<br>");
          } else if (isMultipleSelectQuestion(soal)) {
            const answers = getMultipleSelectCorrectAnswers(soal);
            correctAnswerText = formatAnswersList(answers, {
              emphasize: true,
            });
          } else {
            correctAnswerText = `<strong>${soal.jawaban}</strong>`;
          }
          return {
            isCorrect: false,
            score: 0,
            correctAnswerText,
            explanation: soal.penjelasan,
          };
        }
        if (soal.type === "complex") {
          let correctStatements = 0;
          const totalStatements = soal.pernyataan.length;
          for (let i = 0; i < totalStatements; i++) {
            if (
              jawabanKompleks[index] &&
              jawabanKompleks[index][i] === soal.jawaban[i]
            ) {
              correctStatements++;
            }
          }
          score = totalStatements > 0 ? correctStatements / totalStatements : 0;
          isCorrect = score === 1;
          correctAnswerText = soal.pernyataan
            .map(
              (p, i) =>
                `${p}: <strong>${soal.pilihan[soal.jawaban[i]]}</strong>`
            )
            .join("<br>");
        } else if (soal.type === "short_answer") {
          const userAnswer = jawabanSingkat[index];
          const answers = parseAnswerOptions(soal.jawaban);
          const candidates = answers.length ? answers : [soal.jawaban];
          for (const cand of candidates) {
            const userValue = evaluateNumericAnswer(userAnswer);
            const correctValue = evaluateNumericAnswer(cand);
            if (correctValue !== null) {
              if (
                userValue !== null &&
                Math.abs(userValue - correctValue) < 1e-9
              ) {
                isCorrect = true;
                break;
              }
            } else if (isApproxTextMatch(userAnswer, cand)) {
              isCorrect = true;
              break;
            }
          }
          score = isCorrect ? 1 : 0;
          correctAnswerText = `<strong>${soal.jawaban}</strong>`;
        } else if (isMultipleSelectQuestion(soal)) {
          const userAnswerRaw = jawabanPengguna[index];
          const userAnswers = Array.isArray(userAnswerRaw)
            ? userAnswerRaw
            : userAnswerRaw
              ? [userAnswerRaw]
              : [];
          const correctAnswers = getMultipleSelectCorrectAnswers(soal);
          const correctSet = new Set(
            correctAnswers.map((ans) => normalizeText(ans))
          );
          const userSet = new Set(userAnswers.map((ans) => normalizeText(ans)));
          if (correctSet.size > 0) {
            const allCorrect = Array.from(correctSet).every((ans) =>
              userSet.has(ans)
            );
            const noExtra = Array.from(userSet).every((ans) =>
              correctSet.has(ans)
            );
            isCorrect = allCorrect && noExtra;
          } else {
            isCorrect = false;
          }
          score = isCorrect ? 1 : 0;
          correctAnswerText = formatAnswersList(correctAnswers, {
            emphasize: true,
          });
        } else {
          const userAnswerText = jawabanPengguna[index];
          const correctAnswer = soal.jawaban;

          const normalizedUser = normalizeText(userAnswerText);
          const normalizedCorrect = normalizeText(correctAnswer);
          isCorrect = normalizedUser === normalizedCorrect;

          // Debug logging for answer comparison (can be disabled in production)
          if (!isCorrect && userAnswerText && window.DEBUG_QUIZ) {
            console.group(`Question ${index + 1} - Answer Mismatch`);
            console.log('User answer (raw):', JSON.stringify(userAnswerText));
            console.log('User answer (normalized):', JSON.stringify(normalizedUser));
            console.log('Correct answer (raw):', JSON.stringify(correctAnswer));
            console.log('Correct answer (normalized):', JSON.stringify(normalizedCorrect));
            console.log('Character codes (user):', [...userAnswerText].map(c => c.charCodeAt(0)));
            console.log('Character codes (correct):', [...correctAnswer].map(c => c.charCodeAt(0)));
            console.groupEnd();
          }

          score = isCorrect ? 1 : 0;
          correctAnswerText = `<strong>${correctAnswer}</strong>`;
        }
        return {
          isCorrect,
          score,
          correctAnswerText,
          explanation: soal.penjelasan,
        };
      }
      const normalizeShortAnswer = (answer) => {
        if (!answer) return "";
        let normalized = String(answer).trim().toLowerCase();
        normalized = normalized
          .replace(/Ã‚Â¹/g, "1")
          .replace(/Ã‚Â²/g, "2")
          .replace(/Ã‚Â³/g, "3")
          .replace(/Ã¢ÂÂ´/g, "4")
          .replace(/Ã¢ÂÂµ/g, "5")
          .replace(/Ã¢ÂÂ¶/g, "6")
          .replace(/Ã¢ÂÂ·/g, "7")
          .replace(/Ã¢ÂÂ¸/g, "8")
          .replace(/Ã¢ÂÂ¹/g, "9")
          .replace(/Ã¢ÂÂ°/g, "0");
        normalized = normalized.replace(/[\s{}\^\$]/g, "");
        return normalized;
      };
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
      function applyZoom() {
        DOM.allQuestionTexts.forEach((el) => {
          if (el) el.style.fontSize = `${zoomLevel}%`;
        });
        DOM.allOptionContainers.forEach((container) => {
          if (container) {
            const optionSpans = container.querySelectorAll(".option-text");
            optionSpans.forEach((span) => {
              span.style.fontSize = `${zoomLevel}%`;
            });
          }
        });
      }
      function zoomIn() {
        if (zoomLevel < MAX_ZOOM) {
          zoomLevel += ZOOM_STEP;
          applyZoom();
        }
      }
      function zoomOut() {
        if (zoomLevel > MIN_ZOOM) {
          zoomLevel -= ZOOM_STEP;
          applyZoom();
        }
      }
      function loadMathJax() {
        return new Promise((resolve, reject) => {
          if (window.MathJax) {
            resolve(window.MathJax);
            return;
          }
          window.MathJax = {
            tex: {
              inlineMath: [
                ["$", "$"],
                ["\\(", "\\)"],
              ],
              displayMath: [
                ["$$", "$$"],
                ["\\[", "\\]"],
              ],
              processEscapes: false,
              packages: {
                "[+]": ["ams", "boldsymbol", "color", "mhchem"],
              },
            },
            chtml: {
              linebreaks: {
                automatic: true,
              },
              matchFontHeight: true,
            },
            options: {
              skipHtmlTags: ["script", "noscript", "style", "textarea", "pre"],
              enableMenu: false,
            },
            startup: {
              ready: () => {
                MathJax.startup.defaultReady();
                MathJax.startup.promise.then(() => {
                  console.log("MathJax is loaded, configured, and ready.");
                  resolve(MathJax);
                });
              },
            },
          };
          const script = document.createElement("script");
          script.src =
            "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js";
          script.async = true;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      function renderMathInElement(element) {
        if (window.MathJax && window.MathJax.startup) {
          window.MathJax.startup.promise.then(() => {
            window.MathJax.typesetClear([element]);
            window.MathJax.typesetPromise([element]).catch((err) => {
              console.error("MathJax typesetting error:", err);
            });
          });
        }
      }
      document.addEventListener("contextmenu", (e) => e.preventDefault());
      document.addEventListener("DOMContentLoaded", () => {
        cacheDOMElements();
        initQuiz();
      });
    </script>
  </body>
</html>
